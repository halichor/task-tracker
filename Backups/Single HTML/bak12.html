<!DOCTYPE html>
<html lang="en">

<!-- TO DO:
    1. Backup and import tasks and users
    2. Firebase integration after github hosting (requires DB)
-->

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Task Manager with Users & Admin</title>
    
    <!-- Scripts -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        body {
            padding: 1rem;
            background: #f8f9fa;
        }

        #app {
            display: none;
        }

        .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.3rem;
            padding: 0.3rem 0.5rem;
            background: #fff;
            border-radius: 4px;
            box-shadow: 0 0 3px #ddd;
        }

        .task-item input[type="text"],
        .task-item select {
            border: none;
            background: transparent;
            width: auto;
            min-width: 60px;
        }

        .task-item input[type="text"]:focus,
        .task-item select:focus {
            outline: 1px solid #0d6efd;
            background: #e7f1ff;
        }

        .nav-link.disabled {
            cursor: not-allowed;
        }

        .task-edit-icons {
            display: flex;
            gap: 0.3rem;
            margin-left: 0.5rem;
        }

        .task-checkbox {
            margin-right: 0.5rem;
        }

        .task-item.edit-mode {
            background: #f1f8ff;
        }
    </style>
</head>

<body>

    <!-- LOGIN SCREEN -->
    <div id="auth" class="container" style="max-width: 400px;">
        <h3 class="mb-4">Please Log In</h3>
        <div class="mb-3">
            <input type="text" id="login-username" class="form-control" placeholder="Username"
                autocomplete="username" />
        </div>
        <div class="mb-3">
            <input type="password" id="login-password" class="form-control" placeholder="Password"
                autocomplete="current-password" />
        </div>
        <button id="login-btn" class="btn btn-primary w-100">Login</button>
        <div id="login-error" class="text-danger mt-3"></div>
    </div>

    <!-- MAIN APP -->
    <div id="app" class="container">

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3>Task Manager - User: <span id="current-user-name"></span></h3>
            <button id="logout-btn" class="btn btn-outline-secondary">Logout</button>
        </div>

        <ul class="nav nav-tabs mb-3" id="main-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="today-tab" data-bs-toggle="tab" data-bs-target="#today"
                    type="button" role="tab">Today</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="archive-tab" data-bs-toggle="tab" data-bs-target="#archive" type="button"
                    role="tab">Archive</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="view-users-tab" data-bs-toggle="tab" data-bs-target="#view-users"
                    type="button" role="tab">View Tasks</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button"
                    role="tab">Settings</button>
            </li>
        </ul>

        <div class="tab-content" id="main-tabs-content">
            <!-- Today Tab -->
            <div class="tab-pane fade show active" id="today" role="tabpanel" aria-labelledby="today-tab">
                <div class="mb-3 d-flex gap-2">
                    <select id="task-origin-input" class="form-select" style="max-width:160px;"></select>
                    <input type="text" id="task-activity-input" class="form-control" placeholder="Activity" />
                    <input type="text" id="task-remarks-input" class="form-control" placeholder="Remarks" />
                    <input type="text" id="task-date-input" class="form-control" style="max-width:160px;" />
                </div>
                <button class="btn btn-primary mb-3" id="add-task-btn">Add Task</button>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="mb-0">Today's Tasks</h5>
                    <div id="today-edit-controls" style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-outline-secondary btn-sm" id="today-edit-btn">
                            <span id="today-edit-btn-label">EDIT</span>
                        </button>
                        <button class="btn btn-danger btn-sm" id="today-delete-selected-btn" style="display:none;">
                            Delete Selected
                        </button>
                    </div>
                </div>
                <div id="today-tasks-list" class="mb-4"></div>
            </div>

            <!-- Archive Tab -->
            <div class="tab-pane fade" id="archive" role="tabpanel" aria-labelledby="archive-tab">
                <div class="mb-3">
                    <div id="datepicker" class="datepicker-inline"></div>

                    <!-- Cols Fixed-->
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5>Tasks on <span id="archive-date-display">[select a date]</span></h5>
                        <div id="today-edit-controls" style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-outline-secondary btn-sm" id="archive-edit-btn">
                                <span id="archive-edit-btn-label">EDIT</span>
                            </button>
                            <button class="btn btn-danger btn-sm" id="archive-delete-selected-btn"
                                style="display:none;">
                                Delete Selected
                            </button>
                        </div>
                    </div>

                    <div id="archive-tasks-list"></div>
                </div>
            </div>

            <!-- View Tasks Tab -->
            <div class="tab-pane fade" id="view-users" role="tabpanel" aria-labelledby="view-users-tab">
                <div class="mb-3">
                    <label for="view-tasks-date" class="form-label">Select Date:</label>
                    <div class="input-group date" id="view-tasks-date-group" data-date-format="yyyy-mm-dd"
                        data-date-autoclose="true" data-date-today-highlight="true">
                        <input type="text" id="view-tasks-date" class="form-control" readonly
                            style="background:#fff; cursor:pointer; max-width:200px;" />
                        <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                    </div>
                </div>
                <div class="accordion" id="users-tasks-accordion"></div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
                <div class="row">
                    <!-- Sidebar as Bootstrap nav-pills flex-column -->
                    <div class="col-md-4">
                        <ul class="nav nav-pills flex-column mb-3" id="settings-sidebar" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="sidebar-account-btn" data-bs-toggle="pill"
                                    data-bs-target="#account-section" type="button" role="tab">Account Settings</button>
                            </li>
                            <li class="nav-item" role="presentation" id="sidebar-user-mgmt-li" style="display:none;">
                                <button class="nav-link" id="sidebar-user-mgmt-btn" data-bs-toggle="pill"
                                    data-bs-target="#user-mgmt-section" type="button" role="tab">User
                                    Management</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="sidebar-task-mgmt-btn" data-bs-toggle="pill"
                                    data-bs-target="#task-mgmt-section" type="button" role="tab">Task
                                    Management</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="sidebar-mass-editor-btn" data-bs-toggle="pill"
                                    data-bs-target="#mass-editor-section" type="button" role="tab">Mass Task
                                    Editor</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="sidebar-backup-btn" data-bs-toggle="pill"
                                    data-bs-target="#backup-section" type="button" role="tab">Backup, Import and Export</button>
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-8">
                        <div class="tab-content">
                            <!-- Account Settings Tab -->
                            <div class="tab-pane fade show active" id="account-section" role="tabpanel">
                                <h5>Change Username and Password</h5>
                                <div class="mb-3">
                                    <label for="new-username" class="form-label">New Username</label>
                                    <input type="text" id="new-username" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label for="new-password" class="form-label">New Password</label>
                                    <input type="password" id="new-password" class="form-control" />
                                </div>
                                <button class="btn btn-primary" id="save-settings-btn">Save Changes</button>
                            </div>
                            <!-- User Management Tab (admin only) -->
                            <div class="tab-pane fade" id="user-mgmt-section" role="tabpanel">
                                <h5>User Management</h5>
                                <div id="admin-user-mgmt">
                                    <div class="mb-3">
                                        <label for="admin-new-username" class="form-label">New Username</label>
                                        <input type="text" id="admin-new-username" class="form-control" />
                                    </div>
                                    <div class="mb-3">
                                        <label for="admin-new-password" class="form-label">New Password</label>
                                        <input type="password" id="admin-new-password" class="form-control" />
                                    </div>
                                    <button class="btn btn-success mb-3" id="admin-create-user-btn">Create User</button>
                                    <h6>Existing Users</h6>
                                    <ul id="user-list" class="list-group"></ul>
                                </div>
                            </div>
                            <!-- Task Management Tab -->
                            <div class="tab-pane fade" id="task-mgmt-section" role="tabpanel">
                                <!-- Holidays -->
                                <h5>Holidays</h5>
                                <div class="mb-3">
                                    <label for="holiday-datepicker" class="form-label">Select Date:</label>
                                    <div id="holiday-datepicker"></div>
                                </div>
                                <div class="mb-3">
                                    <label for="holiday-name" class="form-label">Holiday Name</label>
                                    <input type="text" id="holiday-name" class="form-control"
                                        placeholder="e.g. New Year's Day" />
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="holiday-repeat" />
                                    <label class="form-check-label" for="holiday-repeat">
                                        Repeat every year
                                    </label>
                                </div>
                                <button class="btn btn-primary mb-2" id="add-holiday-btn">Add Holiday</button>
                                <div id="holidays-list"></div>

                                <!-- Manage Origins Tab (admin only, shown via JS) -->
                                <div id="origins-admin-section" style="display:none; margin-top:2em;">
                                    <h5>Manage Origins</h5>
                                    <div class="mb-3 d-flex">
                                        <input id="new-origin-input" class="form-control me-2"
                                            placeholder="New origin..." />
                                        <button id="add-origin-btn" class="btn btn-primary">Add</button>
                                    </div>
                                    <div id="origins-admin-list"></div>
                                    <small class="text-muted">Origins cannot be deleted, only archived/unarchived.
                                        Editing an origin will update all tasks using it.</small>
                                </div>
                            </div>
                            <!-- Mass Task Editor Tab -->
                            <div class="tab-pane fade" id="mass-editor-section" role="tabpanel">
                                <h5>Mass Task Editor</h5>
                                <div id="mass-editor-user-select-container" class="mb-3" style="display:none;">
                                    <label for="mass-editor-user-select" class="form-label">Select User:</label>
                                    <select id="mass-editor-user-select" class="form-select"
                                        style="max-width:200px;"></select>
                                </div>
                                <div class="mb-3 d-flex flex-wrap gap-2 align-items-end">
                                    <div>
                                        <label class="form-label">Filter:</label>
                                        <select id="mass-editor-filter-type" class="form-select">
                                            <option value="all">All</option>
                                            <option value="month">Month</option>
                                            <option value="week">Week</option>
                                            <option value="range">Custom Range</option>
                                            <option value="daterange">Date Range</option>
                                        </select>
                                    </div>
                                    <div id="mass-editor-filter-month" style="display:none;">
                                        <input type="month" id="mass-editor-month" class="form-control" />
                                    </div>
                                    <div id="mass-editor-filter-week" style="display:none;">
                                        <input type="week" id="mass-editor-week" class="form-control" />
                                    </div>
                                    <div id="mass-editor-filter-range" style="display:none;">
                                        <input type="text" id="mass-editor-range" class="form-control"
                                            placeholder="Select multiple dates" readonly
                                            style="background:#fff; cursor:pointer; max-width:220px;" />
                                    </div>
                                    <div id="mass-editor-filter-daterange" style="display:none;">
                                        <div class="input-group input-daterange">
                                            <input type="text" id="mass-editor-range-start" class="form-control"
                                                placeholder="Start date" readonly>
                                            <span class="input-group-text">to</span>
                                            <input type="text" id="mass-editor-range-end" class="form-control"
                                                placeholder="End date" readonly>
                                        </div>
                                    </div>
                                    <button class="btn btn-primary" id="mass-editor-apply-filter-btn">Apply
                                        Filter</button>
                                </div>
                                <div class="d-flex gap-2 mb-2">
                                    <button class="btn btn-outline-secondary btn-sm" id="mass-editor-edit-btn">
                                        <span id="mass-editor-edit-btn-label">EDIT</span>
                                    </button>
                                    <button class="btn btn-danger btn-sm" id="mass-editor-delete-selected-btn"
                                        style="display:none;">
                                        Delete Selected
                                    </button>
                                </div>
                                <div id="mass-editor-tasks-list"></div>
                            </div>
                            <!-- Backup, Import and Export Tab -->
                            <div class="tab-pane fade" id="backup-section" role="tabpanel">
                                <h5>Backup, Import and Export</h5>
                                <div id="backup-user-section">
                                    <button class="btn btn-outline-primary mb-2" id="export-my-tasks-btn">Export My Tasks</button>
                                    <input type="file" id="import-my-tasks-input" style="display:none;" accept=".json" />
                                    <button class="btn btn-outline-secondary mb-2" id="import-my-tasks-btn">Import My Tasks</button>
                                    <div id="import-my-tasks-status" class="mt-2"></div>
                                </div>
                                <div id="backup-admin-section" style="display:none;">
                                    <hr>
                                    <h6>Admin: All Users</h6>
                                    <button class="btn btn-outline-primary mb-2" id="export-all-users-btn">Export All Users & Tasks (ZIP)</button>
                                    <input type="file" id="import-all-users-input" style="display:none;" accept=".zip,.json" />
                                    <button class="btn btn-outline-secondary mb-2" id="import-all-users-btn">Import Users/Tasks</button>
                                    <div id="import-all-users-status" class="mt-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="confirmModalLabel">Please Confirm</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="confirmModalBody">
                        <!-- Message goes here -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" id="confirmModalCancel"
                            data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="confirmModalOk">OK</button>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
        <script>
            (() => {
                // Data keys and current user var
                const LS_USERS_KEY = "tm_users";
                const LS_TASKS_KEY = "tm_tasks";
                const LS_ORIGINS_KEY = "tm_origins";
                const SESSION_USER_KEY = "tm_currentUser";
                let currentUser = null;

                // Elements
                const authDiv = document.getElementById("auth");
                const appDiv = document.getElementById("app");
                const loginBtn = document.getElementById("login-btn");
                const logoutBtn = document.getElementById("logout-btn");
                const loginError = document.getElementById("login-error");
                const currentUserNameSpan = document.getElementById("current-user-name");

                // Tabs elements
                const addTaskBtn = document.getElementById("add-task-btn");
                const todayTasksList = document.getElementById("today-tasks-list");

                const newUsernameInput = document.getElementById("new-username");
                const newPasswordInput = document.getElementById("new-password");
                const saveSettingsBtn = document.getElementById("save-settings-btn");

                const adminNewUsername = document.getElementById("admin-new-username");
                const adminNewPassword = document.getElementById("admin-new-password");
                const adminCreateUserBtn = document.getElementById("admin-create-user-btn");
                const userListUl = document.getElementById("user-list");

                // Archive
                const archiveDateDisplay = document.getElementById("archive-date-display");
                const archiveTasksList = document.getElementById("archive-tasks-list");

                // --- Helpers ---
                function getUsers() {
                    let users = JSON.parse(localStorage.getItem(LS_USERS_KEY));
                    if (!users) {
                        users = { admin: { password: "adminpass" } };
                        localStorage.setItem(LS_USERS_KEY, JSON.stringify(users));
                    }
                    return users;
                }
                function saveUsers(users) {
                    localStorage.setItem(LS_USERS_KEY, JSON.stringify(users));
                }
                function getTasks() {
                    return JSON.parse(localStorage.getItem(LS_TASKS_KEY)) || {};
                }
                function saveTasks(tasks) {
                    localStorage.setItem(LS_TASKS_KEY, JSON.stringify(tasks));
                }
                const LS_HOLIDAYS_KEY = "tm_holidays";
                function getHolidays() {
                    return JSON.parse(localStorage.getItem(LS_HOLIDAYS_KEY)) || [];
                }
                function saveHolidays(holidays) {
                    localStorage.setItem(LS_HOLIDAYS_KEY, JSON.stringify(holidays));
                }
                function renderHolidaysList() {
                    const holidays = getHolidays();
                    const listDiv = document.getElementById('holidays-list');
                    if (!holidays.length) {
                        listDiv.innerHTML = "<em>No holidays set.</em>";
                        return;
                    }
                    const ul = document.createElement('ul');
                    ul.className = "list-group";
                    holidays.forEach((h, idx) => {
                        const li = document.createElement('li');
                        li.className = "list-group-item d-flex justify-content-between align-items-center";
                        li.textContent = `${h.name} (${h.date})${h.repeat ? " [Repeats]" : ""}`;
                        const delBtn = document.createElement('button');
                        delBtn.className = "btn btn-sm btn-danger";
                        delBtn.textContent = "Delete";
                        delBtn.onclick = () => {
                            const arr = getHolidays();
                            arr.splice(idx, 1);
                            saveHolidays(arr);
                            renderHolidaysList();
                        };
                        li.appendChild(delBtn);
                        ul.appendChild(li);
                    });
                    listDiv.innerHTML = "";
                    listDiv.appendChild(ul);
                }
                function ensureAllUsersTaskStructure() {
                    const users = getUsers();
                    const tasks = getTasks();
                    let changed = false;
                    Object.keys(users).forEach(username => {
                        if (!tasks[username]) {
                            tasks[username] = { today: [], archive: {} };
                            changed = true;
                        } else {
                            if (!tasks[username].today) {
                                tasks[username].today = [];
                                changed = true;
                            }
                            if (!tasks[username].archive) {
                                tasks[username].archive = {};
                                changed = true;
                            }
                        }
                    });
                    if (changed) saveTasks(tasks);
                }

                // --- Origins Management ---
                function getOrigins() {
                    return JSON.parse(localStorage.getItem(LS_ORIGINS_KEY)) || [];
                }
                function saveOrigins(origins) {
                    localStorage.setItem(LS_ORIGINS_KEY, JSON.stringify(origins));
                }
                function renderOriginsAdmin() {
                    const container = document.getElementById("origins-admin-list");
                    const origins = getOrigins();
                    container.innerHTML = "";
                    origins.forEach((origin, idx) => {
                        const div = document.createElement("div");
                        div.className = "d-flex align-items-center mb-2";
                        // Origin value (editable)
                        const input = document.createElement("input");
                        input.type = "text";
                        input.value = origin.value;
                        input.className = "form-control me-2";
                        input.style.maxWidth = "200px";
                        input.disabled = origin.archived;
                        input.addEventListener("change", () => {
                            const oldValue = origin.value;
                            const newValue = input.value.trim();
                            if (!newValue) return;
                            // Update all tasks globally
                            const tasks = getTasks();
                            Object.values(tasks).forEach(user => {
                                user.today?.forEach(t => { if (t.origin === oldValue) t.origin = newValue; });
                                Object.values(user.archive || {}).forEach(arr => arr.forEach(t => { if (t.origin === oldValue) t.origin = newValue; }));
                            });
                            saveTasks(tasks);
                            // Update origin
                            origins[idx].value = newValue;
                            saveOrigins(origins);
                            renderOriginsAdmin();
                            populateOriginDropdown();
                            loadTodayTasks();
                            loadArchiveDate(document.getElementById('archive-date-display').textContent);
                        });
                        div.appendChild(input);
                        // Archive/unarchive button
                        const btn = document.createElement("button");
                        btn.className = "btn btn-sm " + (origin.archived ? "btn-secondary" : "btn-outline-secondary");
                        btn.textContent = origin.archived ? "Unarchive" : "Archive";
                        btn.addEventListener("click", () => {
                            origins[idx].archived = !origins[idx].archived;
                            saveOrigins(origins);
                            renderOriginsAdmin();
                            populateOriginDropdown();
                        });
                        div.appendChild(btn);
                        container.appendChild(div);
                    });
                }
                document.getElementById("add-origin-btn").addEventListener("click", () => {
                    const input = document.getElementById("new-origin-input");
                    const value = input.value.trim();
                    if (!value) return;
                    const origins = getOrigins();
                    if (origins.some(o => o.value === value)) {
                        alert("Origin already exists.");
                        return;
                    }
                    origins.push({ value, archived: false });
                    saveOrigins(origins);
                    input.value = "";
                    renderOriginsAdmin();
                    populateOriginDropdown();
                });
                function setupOriginsAdminTab() {
                    const isAdmin = currentUser === "admin";
                    document.getElementById("origins-admin-section").style.display = isAdmin ? "" : "none";
                    if (isAdmin) renderOriginsAdmin();
                }
                function populateOriginDropdown() {
                    const select = document.getElementById("task-origin-input");
                    select.innerHTML = "";
                    getOrigins().filter(o => !o.archived).forEach(origin => {
                        const opt = document.createElement("option");
                        opt.value = origin.value;
                        opt.textContent = origin.value;
                        select.appendChild(opt);
                    });
                }

                // --- Login ---
                function validateLogin(username, password) {
                    const users = getUsers();
                    return users[username] && users[username].password === password;
                }
                function afterLoginSetup() {
                    ensureAllUsersTaskStructure();
                    authDiv.style.display = "none";
                    appDiv.style.display = "block";
                    currentUserNameSpan.textContent = currentUser;
                    setupAdminTab();
                    setupOriginsAdminTab();
                    populateOriginDropdown();
                    loadTodayTasks();
                    loadArchiveDate(new Date());
                    clearLoginInputs();
                    clearSettingsInputs();
                }
                loginBtn.addEventListener("click", () => {
                    const username = document.getElementById("login-username").value.trim();
                    const password = document.getElementById("login-password").value;
                    if (!username || !password) {
                        loginError.textContent = "Please enter username and password.";
                        return;
                    }
                    if (validateLogin(username, password)) {
                        currentUser = username;
                        sessionStorage.setItem(SESSION_USER_KEY, currentUser);
                        loginError.textContent = "";
                        afterLoginSetup();
                    } else {
                        loginError.textContent = "Invalid username or password.";
                    }
                });
                logoutBtn.addEventListener("click", () => {
                    currentUser = null;
                    sessionStorage.removeItem(SESSION_USER_KEY);
                    authDiv.style.display = "block";
                    appDiv.style.display = "none";
                    clearLoginInputs();
                    clearSettingsInputs();
                    clearTasksDisplay();
                    clearAdminUserList();
                });
                function clearLoginInputs() {
                    document.getElementById("login-username").value = "";
                    document.getElementById("login-password").value = "";
                    loginError.textContent = "";
                }
                function clearSettingsInputs() {
                    newUsernameInput.value = "";
                    newPasswordInput.value = "";
                }
                function clearTasksDisplay() {
                    todayTasksList.innerHTML = "";
                    archiveTasksList.innerHTML = "";
                    document.getElementById("users-tasks-accordion").innerHTML = "";
                }
                function clearAdminUserList() {
                    userListUl.innerHTML = "";
                }
                // --- Admin Tab setup ---
                function setupAdminTab() {
                    const isAdmin = currentUser === "admin";
                    // Only show User Management in settings for admin
                    const userMgmtLi = document.getElementById('sidebar-user-mgmt-li');
                    const adminUserMgmt = document.getElementById('admin-user-mgmt');
                    if (userMgmtLi) userMgmtLi.style.display = isAdmin ? "" : "none";
                    if (adminUserMgmt) adminUserMgmt.style.display = isAdmin ? "" : "none";
                    if (isAdmin) loadAdminUserList();
                }
                function loadAdminUserList() {
                    const users = getUsers();
                    userListUl.innerHTML = "";
                    Object.keys(users).forEach(username => {
                        if (username === "admin") return; // Don't show admin in the list
                        const li = document.createElement("li");
                        li.className = "list-group-item d-flex justify-content-between align-items-center";
                        li.textContent = username;
                        const delBtn = document.createElement("button");
                        delBtn.className = "btn btn-sm btn-danger";
                        delBtn.textContent = "Delete";
                        delBtn.onclick = async () => {
                            if (confirm(`Delete user "${username}"? This cannot be undone.`)) {
                                const users = getUsers();
                                const tasks = getTasks();
                                delete users[username];
                                delete tasks[username];
                                saveUsers(users);
                                saveTasks(tasks);
                                ensureAllUsersTaskStructure();
                                loadAdminUserList();
                            }
                        };
                        li.appendChild(delBtn);
                        userListUl.appendChild(li);
                    });
                }
                adminCreateUserBtn && adminCreateUserBtn.addEventListener("click", () => {
                    const username = adminNewUsername.value.trim();
                    const password = adminNewPassword.value;
                    if (!username || !password) {
                        alert("Please enter a username and password.");
                        return;
                    }
                    const users = getUsers();
                    if (users[username]) {
                        alert("User already exists.");
                        return;
                    }
                    users[username] = { password };
                    saveUsers(users);
                    ensureAllUsersTaskStructure();
                    adminNewUsername.value = "";
                    adminNewPassword.value = "";
                    loadAdminUserList();
                });

                // --- Tasks functions ---
                function loadTodayTasks() {
                    const tasks = getTasks();
                    const todayStr = (new Date()).toISOString().slice(0, 10);
                    let userTasks = (tasks[currentUser] && tasks[currentUser].today) || [];
                    // Only show tasks with today's date
                    userTasks = userTasks.filter(t => t.date === todayStr);
                    renderTaskList(userTasks, todayTasksList, true, todayStr);
                }
                function addTaskToDate(taskObj, taskDate) {
                    if (!taskObj || !taskObj.origin || !taskObj.activity || !taskDate) return;
                    const tasks = getTasks();
                    if (!tasks[currentUser]) tasks[currentUser] = { today: [], archive: {} };
                    const todayStr = (new Date()).toISOString().slice(0, 10);
                    const newTask = { origin: taskObj.origin, activity: taskObj.activity, remarks: taskObj.remarks || "", date: taskDate };
                    if (taskDate === todayStr) {
                        tasks[currentUser].today.push(newTask);
                    } else {
                        if (!tasks[currentUser].archive[taskDate]) tasks[currentUser].archive[taskDate] = [];
                        tasks[currentUser].archive[taskDate].push(newTask);
                    }
                    saveTasks(tasks);
                }
                addTaskBtn.addEventListener("click", () => {
                    const origin = document.getElementById("task-origin-input").value;
                    const activity = document.getElementById("task-activity-input").value.trim();
                    const remarks = document.getElementById("task-remarks-input").value.trim();
                    const taskDate = document.getElementById("task-date-input").value;
                    if (!origin || !activity || !taskDate) return;
                    addTaskToDate({ origin, activity, remarks }, taskDate);
                    document.getElementById("task-activity-input").value = "";
                    document.getElementById("task-remarks-input").value = "";
                    $('#task-date-input').datepicker('setDate', new Date());
                    loadTodayTasks();
                });

                // --- Today Tab Edit Mode ---
                let todayEditMode = false;
                let todaySelectedTasks = new Set();
                function renderTaskList(tasksArray, container, isEditable, currentDate) {
                    container.innerHTML = "";
                    if (tasksArray.length === 0) {
                        container.innerHTML = "<p><em>No tasks</em></p>";
                        return;
                    }
                    tasksArray.forEach((taskObj, idx) => {
                        const div = document.createElement("div");
                        div.className = "task-item";
                        if (todayEditMode && isEditable) div.classList.add("edit-mode");

                        if (todayEditMode && isEditable) {
                            // Checkbox for selection
                            const checkbox = document.createElement("input");
                            checkbox.type = "checkbox";
                            checkbox.className = "task-checkbox";
                            checkbox.checked = todaySelectedTasks.has(idx);
                            checkbox.addEventListener("change", () => {
                                if (checkbox.checked) todaySelectedTasks.add(idx);
                                else todaySelectedTasks.delete(idx);
                            });
                            div.appendChild(checkbox);

                            // Editable origin dropdown
                            const origins = getOrigins().filter(o => !o.archived);
                            const originSelect = document.createElement("select");
                            originSelect.className = "form-select form-select-sm me-2";
                            originSelect.style.maxWidth = "120px";
                            origins.forEach(o => {
                                const opt = document.createElement("option");
                                opt.value = o.value;
                                opt.textContent = o.value;
                                if (taskObj.origin === o.value) opt.selected = true;
                                originSelect.appendChild(opt);
                            });
                            originSelect.value = taskObj.origin;
                            originSelect.addEventListener("change", () => {
                                const tasks = getTasks();
                                tasks[currentUser].today[idx].origin = originSelect.value;
                                saveTasks(tasks);
                            });
                            div.appendChild(originSelect);

                            // Editable input for activity
                            const activityInput = document.createElement("input");
                            activityInput.type = "text";
                            activityInput.value = taskObj.activity;
                            activityInput.className = "form-control form-control-sm me-2";
                            activityInput.style.maxWidth = "180px";
                            activityInput.addEventListener("change", () => {
                                const tasks = getTasks();
                                tasks[currentUser].today[idx].activity = activityInput.value.trim();
                                saveTasks(tasks);
                            });
                            div.appendChild(activityInput);

                            // Editable input for remarks
                            const remarksInput = document.createElement("input");
                            remarksInput.type = "text";
                            remarksInput.value = taskObj.remarks || "";
                            remarksInput.className = "form-control form-control-sm me-2";
                            remarksInput.style.maxWidth = "180px";
                            remarksInput.addEventListener("change", () => {
                                const tasks = getTasks();
                                tasks[currentUser].today[idx].remarks = remarksInput.value.trim();
                                saveTasks(tasks);
                            });
                            div.appendChild(remarksInput);

                            // Editable input for date
                            const dateInput = document.createElement("input");
                            dateInput.type = "text";
                            dateInput.value = taskObj.date;
                            dateInput.style.width = "120px";
                            $(dateInput).datepicker({
                                format: 'yyyy-mm-dd',
                                autoclose: true,
                                todayHighlight: true,
                                orientation: "bottom auto"
                            });
                            $(dateInput).datepicker({
                                format: 'yyyy-mm-dd',
                                autoclose: true,
                                todayHighlight: true,
                                orientation: "bottom auto"
                            }).on('changeDate', function (e) {
                                const tasks = getTasks();
                                const newDate = e.format('yyyy-mm-dd');
                                const todayObj = new Date();
                                const todayStr = todayObj.getFullYear() + "-" +
                                    String(todayObj.getMonth() + 1).padStart(2, "0") + "-" +
                                    String(todayObj.getDate()).padStart(2, "0");

                                // Find the task by unique fields to avoid index issues
                                const taskList = tasks[currentUser].today;
                                const taskIdx = taskList.findIndex(t =>
                                    t.origin === taskObj.origin &&
                                    t.activity === taskObj.activity &&
                                    t.remarks === taskObj.remarks &&
                                    t.date === taskObj.date
                                );
                                if (taskIdx === -1) return;

                                const movedTask = taskList.splice(taskIdx, 1)[0];
                                movedTask.date = newDate;

                                if (newDate === todayStr) {
                                    taskList.push(movedTask);
                                } else {
                                    if (!tasks[currentUser].archive[newDate]) tasks[currentUser].archive[newDate] = [];
                                    tasks[currentUser].archive[newDate].push(movedTask);
                                }
                                saveTasks(tasks);
                                loadTodayTasks();
                                loadArchiveDate(newDate);
                            });
                            div.appendChild(dateInput);

                            // Edit/Delete icons
                            const icons = document.createElement("span");
                            icons.className = "task-edit-icons";

                            // Edit icon (focus input)
                            const editBtn = document.createElement("button");
                            editBtn.className = "btn btn-sm btn-outline-primary";
                            editBtn.textContent = "Edit";
                            editBtn.addEventListener("click", () => {
                                activityInput.focus();
                            });
                            icons.appendChild(editBtn);

                            // Delete icon (delete this task)
                            const delBtn = document.createElement("button");
                            delBtn.className = "btn btn-sm btn-outline-danger";
                            delBtn.textContent = "Delete";
                            delBtn.addEventListener("click", () => {
                                const tasks = getTasks();
                                tasks[currentUser].today.splice(idx, 1);
                                saveTasks(tasks);
                                loadTodayTasks();
                            });
                            icons.appendChild(delBtn);

                            div.appendChild(icons);
                        } else {
                            // Not in edit mode: show all fields
                            div.innerHTML = `<strong>${taskObj.origin}</strong> | <span>${taskObj.activity}</span> | <em>${taskObj.remarks || ""}</em> <span class="text-muted">(${taskObj.date})</span>`;
                        }

                        container.appendChild(div);
                    });
                }

                // --- Today Edit Button Logic ---
                const todayEditBtn = document.getElementById("today-edit-btn");
                const todayDeleteSelectedBtn = document.getElementById("today-delete-selected-btn");
                todayEditBtn.addEventListener("click", async () => {
                    if (!todayEditMode) {
                        todayEditMode = true;
                        todayEditBtn.querySelector("#today-edit-btn-label").textContent = "DONE";
                        todayDeleteSelectedBtn.style.display = "";
                        todaySelectedTasks.clear();
                        loadTodayTasks();
                    } else {
                        // If any selected, confirm deletion
                        if (todaySelectedTasks.size > 0) {
                            const confirmed = await showConfirmModal("Are you sure you want to delete the selected tasks?");
                            if (confirmed) {
                                const tasks = getTasks();
                                // Remove by index, highest to lowest to avoid reindexing issues
                                const idxs = Array.from(todaySelectedTasks).sort((a, b) => b - a);
                                idxs.forEach(idx => {
                                    tasks[currentUser].today.splice(idx, 1);
                                });
                                saveTasks(tasks);
                            }
                            todaySelectedTasks.clear();
                        }
                        todayEditMode = false;
                        todayEditBtn.querySelector("#today-edit-btn-label").textContent = "EDIT";
                        todayDeleteSelectedBtn.style.display = "none";
                        loadTodayTasks();
                    }
                });
                todayDeleteSelectedBtn.addEventListener("click", async () => {
                    if (todaySelectedTasks.size === 0) {
                        alert("No tasks selected.");
                        return;
                    }
                    const confirmed = await showConfirmModal("Are you sure you want to delete the selected tasks?");
                    if (!confirmed) return;
                    const tasks = getTasks();
                    // Remove by index, highest to lowest
                    const idxs = Array.from(todaySelectedTasks).sort((a, b) => b - a);
                    idxs.forEach(idx => {
                        tasks[currentUser].today.splice(idx, 1);
                    });
                    saveTasks(tasks);
                    todaySelectedTasks.clear();
                    loadTodayTasks();
                });

                // --- Archive Tab Edit Mode ---
                const archiveEditBtn = document.getElementById("archive-edit-btn");
                const archiveDeleteSelectedBtn = document.getElementById("archive-delete-selected-btn");
                let archiveEditMode = false;
                let archiveSelectedTasks = new Set();
                archiveEditBtn.addEventListener("click", async () => {
                    if (!archiveEditMode) {
                        archiveEditMode = true;
                        archiveEditBtn.querySelector("#archive-edit-btn-label").textContent = "DONE";
                        archiveDeleteSelectedBtn.style.display = "";
                        archiveSelectedTasks.clear();
                        loadArchiveDate(document.getElementById('archive-date-display').textContent);
                    } else {
                        // Confirm deletion if any selected
                        if (archiveSelectedTasks.size > 0) {
                            const confirmed = await showConfirmModal("Are you sure you want to delete the selected tasks?");
                            if (confirmed) {
                                const tasks = getTasks();
                                const dateStr = document.getElementById('archive-date-display').textContent;
                                const todayObj = new Date();
                                const todayStr = todayObj.getFullYear() + "-" +
                                    String(todayObj.getMonth() + 1).padStart(2, "0") + "-" +
                                    String(todayObj.getDate()).padStart(2, "0");
                                let arr;
                                if (dateStr === todayStr) {
                                    arr = tasks[currentUser].today;
                                } else {
                                    arr = tasks[currentUser].archive[dateStr] || [];
                                }
                                // Remove by index, highest to lowest
                                const idxs = Array.from(archiveSelectedTasks).sort((a, b) => b - a);
                                idxs.forEach(idx => arr.splice(idx, 1));
                                saveTasks(tasks);
                            }
                            archiveSelectedTasks.clear();
                        }
                        archiveEditMode = false;
                        archiveEditBtn.querySelector("#archive-edit-btn-label").textContent = "EDIT";
                        archiveDeleteSelectedBtn.style.display = "none";
                        loadArchiveDate(new Date(document.getElementById('archive-date-display').textContent));
                    }
                });
                archiveDeleteSelectedBtn.addEventListener("click", async () => {
                    if (archiveSelectedTasks.size === 0) {
                        alert("No tasks selected.");
                        return;
                    }
                    const confirmed = await showConfirmModal("Are you sure you want to delete the selected tasks?");
                    if (!confirmed) return;
                    const tasks = getTasks();
                    const dateStr = document.getElementById('archive-date-display').textContent;
                    const todayObj = new Date();
                    const todayStr = todayObj.getFullYear() + "-" +
                        String(todayObj.getMonth() + 1).padStart(2, "0") + "-" +
                        String(todayObj.getDate()).padStart(2, "0");
                    let arr;
                    if (dateStr === todayStr) {
                        arr = tasks[currentUser].today;
                    } else {
                        arr = tasks[currentUser].archive[dateStr] || [];
                    }
                    // Remove by index, highest to lowest
                    const idxs = Array.from(archiveSelectedTasks).sort((a, b) => b - a);
                    idxs.forEach(idx => arr.splice(idx, 1));
                    saveTasks(tasks);
                    archiveSelectedTasks.clear();
                    loadArchiveDate(new Date(dateStr));
                });
                function renderArchiveTaskList(tasksArray, container, archiveDate, todayStr) {
                    container.innerHTML = "";
                    if (tasksArray.length === 0) {
                        container.innerHTML = "<p><em>No tasks</em></p>";
                        return;
                    }
                    tasksArray.forEach((taskObj, idx) => {
                        const div = document.createElement("div");
                        div.className = "task-item";
                        if (archiveEditMode) div.classList.add("edit-mode");

                        if (archiveEditMode) {
                            // Checkbox for selection
                            const checkbox = document.createElement("input");
                            checkbox.type = "checkbox";
                            checkbox.className = "task-checkbox";
                            checkbox.checked = archiveSelectedTasks.has(idx);
                            checkbox.addEventListener("change", () => {
                                if (checkbox.checked) archiveSelectedTasks.add(idx);
                                else archiveSelectedTasks.delete(idx);
                            });
                            div.appendChild(checkbox);

                            // Editable origin dropdown
                            const origins = getOrigins().filter(o => !o.archived);
                            const originSelect = document.createElement("select");
                            originSelect.className = "form-select form-select-sm me-2";
                            originSelect.style.maxWidth = "120px";
                            origins.forEach(o => {
                                const opt = document.createElement("option");
                                opt.value = o.value;
                                opt.textContent = o.value;
                                if (taskObj.origin === o.value) opt.selected = true;
                                originSelect.appendChild(opt);
                            });
                            originSelect.value = taskObj.origin;
                            originSelect.addEventListener("change", () => {
                                const tasks = getTasks();
                                if (archiveDate === todayStr) {
                                    const tIdx = tasks[currentUser].today.findIndex(t => t.origin === taskObj.origin && t.activity === taskObj.activity && t.date === taskObj.date && t.remarks === taskObj.remarks);
                                    if (tIdx > -1) tasks[currentUser].today[tIdx].origin = originSelect.value;
                                } else {
                                    tasks[currentUser].archive[archiveDate][idx].origin = originSelect.value;
                                }
                                saveTasks(tasks);
                            });
                            div.appendChild(originSelect);

                            // Editable input for activity
                            const activityInput = document.createElement("input");
                            activityInput.type = "text";
                            activityInput.value = taskObj.activity;
                            activityInput.className = "form-control form-control-sm me-2";
                            activityInput.style.maxWidth = "180px";
                            activityInput.addEventListener("change", () => {
                                const tasks = getTasks();
                                if (archiveDate === todayStr) {
                                    const tIdx = tasks[currentUser].today.findIndex(t => t.origin === taskObj.origin && t.activity === taskObj.activity && t.date === taskObj.date && t.remarks === taskObj.remarks);
                                    if (tIdx > -1) tasks[currentUser].today[tIdx].activity = activityInput.value.trim();
                                } else {
                                    tasks[currentUser].archive[archiveDate][idx].activity = activityInput.value.trim();
                                }
                                saveTasks(tasks);
                            });
                            div.appendChild(activityInput);

                            // Editable input for remarks
                            const remarksInput = document.createElement("input");
                            remarksInput.type = "text";
                            remarksInput.value = taskObj.remarks || "";
                            remarksInput.className = "form-control form-control-sm me-2";
                            remarksInput.style.maxWidth = "180px";
                            remarksInput.addEventListener("change", () => {
                                const tasks = getTasks();
                                if (archiveDate === todayStr) {
                                    const tIdx = tasks[currentUser].today.findIndex(t => t.origin === taskObj.origin && t.activity === taskObj.activity && t.date === taskObj.date && t.remarks === taskObj.remarks);
                                    if (tIdx > -1) tasks[currentUser].today[tIdx].remarks = remarksInput.value.trim();
                                } else {
                                    tasks[currentUser].archive[archiveDate][idx].remarks = remarksInput.value.trim();
                                }
                                saveTasks(tasks);
                            });
                            div.appendChild(remarksInput);

                            // Editable input for date
                            const dateInput = document.createElement("input");
                            dateInput.type = "text";
                            dateInput.value = taskObj.date;
                            dateInput.style.width = "120px";
                            $(dateInput).datepicker({
                                format: 'yyyy-mm-dd',
                                autoclose: true,
                                todayHighlight: true,
                                orientation: "bottom auto"
                            });
                            $(dateInput).datepicker({
                                format: 'yyyy-mm-dd',
                                autoclose: true,
                                todayHighlight: true,
                                orientation: "bottom auto"
                            }).on('changeDate', function (e) {
                                const tasks = getTasks();
                                const newDate = e.format('yyyy-mm-dd');
                                const todayObj = new Date();
                                const todayStr = todayObj.getFullYear() + "-" +
                                    String(todayObj.getMonth() + 1).padStart(2, "0") + "-" +
                                    String(todayObj.getDate()).padStart(2, "0");

                                let movedTask;
                                if (archiveDate === todayStr) {
                                    // Find in today list
                                    const taskList = tasks[currentUser].today;
                                    const taskIdx = taskList.findIndex(t =>
                                        t.origin === taskObj.origin &&
                                        t.activity === taskObj.activity &&
                                        t.remarks === taskObj.remarks &&
                                        t.date === taskObj.date
                                    );
                                    if (taskIdx === -1) return;
                                    movedTask = taskList.splice(taskIdx, 1)[0];
                                } else {
                                    // Find in archive list
                                    const taskList = tasks[currentUser].archive[archiveDate];
                                    const taskIdx = taskList.findIndex(t =>
                                        t.origin === taskObj.origin &&
                                        t.activity === taskObj.activity &&
                                        t.remarks === taskObj.remarks &&
                                        t.date === taskObj.date
                                    );
                                    if (taskIdx === -1) return;
                                    movedTask = taskList.splice(taskIdx, 1)[0];
                                }
                                movedTask.date = newDate;

                                if (newDate === todayStr) {
                                    tasks[currentUser].today.push(movedTask);
                                } else {
                                    if (!tasks[currentUser].archive[newDate]) tasks[currentUser].archive[newDate] = [];
                                    tasks[currentUser].archive[newDate].push(movedTask);
                                }
                                saveTasks(tasks);
                                loadArchiveDate(newDate);
                                loadTodayTasks();
                            });
                            div.appendChild(dateInput);

                            // Edit/Delete icons
                            const icons = document.createElement("span");
                            icons.className = "task-edit-icons";

                            // Edit icon (focus input)
                            const editBtn = document.createElement("button");
                            editBtn.className = "btn btn-sm btn-outline-primary";
                            editBtn.textContent = "Edit";
                            editBtn.addEventListener("click", () => {
                                activityInput.focus();
                            });
                            icons.appendChild(editBtn);

                            // Delete icon (delete this task)
                            const delBtn = document.createElement("button");
                            delBtn.className = "btn btn-sm btn-outline-danger";
                            delBtn.textContent = "Delete";
                            delBtn.addEventListener("click", async () => {
                                const confirmed = await showConfirmModal("Are you sure you want to delete this task?");
                                if (!confirmed) return;
                                const tasks = getTasks();
                                if (archiveDate === todayStr) {
                                    const tIdx = tasks[currentUser].today.findIndex(t => t.origin === taskObj.origin && t.activity === taskObj.activity && t.date === taskObj.date && t.remarks === taskObj.remarks);
                                    if (tIdx > -1) tasks[currentUser].today.splice(tIdx, 1);
                                } else {
                                    tasks[currentUser].archive[archiveDate].splice(idx, 1);
                                }
                                saveTasks(tasks);
                                loadArchiveDate(new Date(archiveDate));
                            });
                            icons.appendChild(delBtn);

                            div.appendChild(icons);
                        } else {
                            // Read-only
                            div.innerHTML = `<strong>${taskObj.origin}</strong> | <span>${taskObj.activity}</span> | <em>${taskObj.remarks || ""}</em> <span class="text-muted">(${taskObj.date})</span>`;
                        }

                        container.appendChild(div);
                    });
                }

                // --- Archive and View Tasks Fixes ---
                function loadArchiveDate(dateInput) {
                    let dateObj;
                    if (dateInput instanceof Date && !isNaN(dateInput)) {
                        dateObj = dateInput;
                    } else if (typeof dateInput === "string" && /^\d{4}-\d{2}-\d{2}$/.test(dateInput)) {
                        // Parse yyyy-mm-dd string
                        const [yyyy, mm, dd] = dateInput.split('-');
                        dateObj = new Date(Number(yyyy), Number(mm) - 1, Number(dd));
                    } else {
                        dateObj = new Date();
                    }
                    const yyyy = dateObj.getFullYear();
                    const mm = (dateObj.getMonth() + 1).toString().padStart(2, "0");
                    const dd = dateObj.getDate().toString().padStart(2, "0");
                    const dateStr = `${yyyy}-${mm}-${dd}`;

                    const tasks = getTasks();
                    const userData = tasks[currentUser] || {};
                    const archivedTasks = userData.archive || {};
                    const todayTasks = userData.today || [];

                    let tasksForDate = (archivedTasks[dateStr] || []).filter(t => t && typeof t === "object");

                    const todayObj = new Date();
                    const todayStr = `${todayObj.getFullYear()}-${(todayObj.getMonth() + 1).toString().padStart(2, "0")}-${todayObj.getDate().toString().padStart(2, "0")}`;
                    if (dateStr === todayStr) {
                        tasksForDate = tasksForDate.concat(
                            todayTasks.filter(t => t && typeof t === "object" && t.date === todayStr)
                        );
                    }

                    renderArchiveTaskList(tasksForDate, archiveTasksList, dateStr, todayStr);
                }

                function loadUsersTasksForDate(dateStr) {
                    const users = getUsers();
                    const tasks = getTasks();
                    const accordion = document.getElementById("users-tasks-accordion");
                    accordion.innerHTML = "";

                    Object.keys(users).forEach((username, index) => {
                        const item = document.createElement("div");
                        item.className = "accordion-item";

                        const headerId = `heading-${index}`;
                        const collapseId = `collapse-${index}`;

                        const header = document.createElement("h2");
                        header.className = "accordion-header";
                        header.id = headerId;

                        const button = document.createElement("button");
                        button.className = "accordion-button collapsed";
                        button.type = "button";
                        button.setAttribute("data-bs-toggle", "collapse");
                        button.setAttribute("data-bs-target", `#${collapseId}`);
                        button.setAttribute("aria-expanded", "false");
                        button.setAttribute("aria-controls", collapseId);
                        button.textContent = username;

                        header.appendChild(button);

                        const collapse = document.createElement("div");
                        collapse.id = collapseId;
                        collapse.className = "accordion-collapse collapse";
                        collapse.setAttribute("aria-labelledby", headerId);
                        collapse.setAttribute("data-bs-parent", "#users-tasks-accordion");

                        const body = document.createElement("div");
                        body.className = "accordion-body";

                        // Collect tasks for the user on the selected date
                        let userTasksForDate = [];
                        if (tasks[username]) {
                            if (tasks[username].archive && tasks[username].archive[dateStr]) {
                                userTasksForDate = userTasksForDate.concat(tasks[username].archive[dateStr]);
                            }
                            // Include today's tasks if the selected date is today
                            const todayObj = new Date();
                            const todayStr = todayObj.getFullYear() + "-" +
                                String(todayObj.getMonth() + 1).padStart(2, "0") + "-" +
                                String(todayObj.getDate()).padStart(2, "0");
                            if (dateStr === todayStr && tasks[username].today) {
                                userTasksForDate = userTasksForDate.concat(tasks[username].today.filter(t => t.date === todayStr));
                            }
                        }

                        // Inject holiday
                        const holidays = getHolidayForDate(dateStr);
                        holidays.forEach(h => {
                            userTasksForDate.unshift({ text: `Holiday - ${h.name}`, date: dateStr });
                        });

                        if (userTasksForDate.length === 0) {
                            body.innerHTML = "<p><em>No tasks for this date.</em></p>";
                        } else {
                            const ul = document.createElement("ul");
                            ul.className = "list-group";
                            userTasksForDate.forEach(task => {
                                const li = document.createElement("li");
                                li.className = "list-group-item";
                                if (task.text) {
                                    li.textContent = `${task.text} (${task.date})`; // holiday
                                } else if (task.origin && task.activity) {
                                    li.innerHTML = `<strong>${task.origin}</strong> | <span>${task.activity}</span> | <em>${task.remarks || ""}</em> <span class="text-muted">(${task.date})</span>`;
                                } else {
                                    li.innerHTML = `<em>Corrupted or incomplete task data</em> <span class="text-muted">(${task.date || ""})</span>`;
                                }
                                ul.appendChild(li);
                            });
                            body.appendChild(ul);
                        }

                        collapse.appendChild(body);
                        item.appendChild(header);
                        item.appendChild(collapse);
                        accordion.appendChild(item);
                    });
                }

                // --- On page load, check session ---
                function init() {
                    const savedUser = sessionStorage.getItem(SESSION_USER_KEY);
                    if (savedUser && getUsers()[savedUser]) {
                        currentUser = savedUser;
                        afterLoginSetup();
                    } else {
                        authDiv.style.display = "block";
                        appDiv.style.display = "none";
                    }
                    //Initialize task list
                    document.getElementById('today-tab').addEventListener('shown.bs.tab', function () {
                        loadTodayTasks();
                    });
                    document.getElementById('archive-tab').addEventListener('shown.bs.tab', function () {
                        loadArchiveDate(document.getElementById('archive-date-display').textContent);
                    });
                    document.getElementById('view-users-tab').addEventListener('shown.bs.tab', function () {
                        const date = document.getElementById('view-tasks-date').value;
                        loadUsersTasksForDate(date);
                    });
                    document.getElementById('settings-tab').addEventListener('shown.bs.tab', function () {
                        setupOriginsAdminTab();
                    });
                    document.getElementById('sidebar-mass-editor-btn').addEventListener('shown.bs.tab', function () {
                        setupMassEditorTab();
                    });
                }
                init();

                // --- Datepicker and holiday setup ---
                $(document).ready(function () {
                    // HOLIDAY datepicker
                    $('#holiday-datepicker').datepicker({
                        format: 'yyyy-mm-dd',
                        todayHighlight: true,
                        autoclose: true,
                        orientation: "bottom auto"
                    });
                    // TODAY datepicker
                    $('#task-date-input').datepicker({
                        format: 'yyyy-mm-dd',
                        todayHighlight: true,
                        autoclose: true,
                        orientation: "bottom auto"
                    });
                    $('#task-date-input').datepicker('setDate', new Date());
                    // ARCHIVE datepicker
                    $('#datepicker').datepicker({
                        format: 'yyyy-mm-dd',
                        todayHighlight: true,
                        autoclose: true,
                        orientation: "bottom auto"
                    }).on('changeDate', function (e) {
                        const date = e.format('yyyy-mm-dd');
                        document.getElementById('archive-date-display').textContent = date;
                        loadArchiveDate(new Date(date));
                    });
                    // VIEW TASKS datepicker
                    $('#view-tasks-date-group').datepicker({
                        format: 'yyyy-mm-dd',
                        todayHighlight: true,
                        autoclose: true,
                        orientation: "bottom auto"
                    }).on('changeDate', function (e) {
                        const date = e.format('yyyy-mm-dd');
                        $('#view-tasks-date').val(date);
                        loadUsersTasksForDate(date);
                    });
                    // Set initial date for view tasks
                    const today = new Date();
                    const todayStr = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
                    $('#view-tasks-date').val(todayStr);
                    loadUsersTasksForDate(todayStr);
                    // Set initial archive date display
                    const todayArchive = new Date();
                    const todayArchiveStr = todayArchive.getFullYear() + '-' + String(todayArchive.getMonth() + 1).padStart(2, '0') + '-' + String(todayArchive.getDate()).padStart(2, '0');
                    $('#datepicker').datepicker('setDate', todayArchiveStr);
                    document.getElementById('archive-date-display').textContent = todayArchiveStr;
                    renderHolidaysList();
                    populateOriginDropdown();
                });

                // Add holiday
                document.getElementById('add-holiday-btn').addEventListener('click', function () {
                    const date = $('#holiday-datepicker').datepicker('getFormattedDate');
                    const name = document.getElementById('holiday-name').value.trim();
                    const repeat = document.getElementById('holiday-repeat').checked;
                    if (!date || !name) {
                        alert("Please select a date and enter a holiday name.");
                        return;
                    }
                    const holidays = getHolidays();
                    holidays.push({ date, name, repeat });
                    saveHolidays(holidays);
                    renderHolidaysList();
                    document.getElementById('holiday-name').value = "";
                    document.getElementById('holiday-repeat').checked = false;
                });

                // --- Helper for Holidays ---
                function getHolidayForDate(dateStr) {
                    const holidays = getHolidays();
                    const [yyyy, mm, dd] = dateStr.split('-');
                    return holidays.filter(h => {
                        if (h.repeat) {
                            // Match month and day
                            const [hyyyy, hmm, hdd] = h.date.split('-');
                            return hmm === mm && hdd === dd;
                        }
                        return h.date === dateStr;
                    });
                }

                // --- Confirmation Modal ---
                function showConfirmModal(message) {
                    return new Promise((resolve) => {
                        const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
                        document.getElementById('confirmModalBody').textContent = message;
                        const okBtn = document.getElementById('confirmModalOk');
                        const cancelBtn = document.getElementById('confirmModalCancel');
                        function cleanup(result) {
                            okBtn.removeEventListener('click', onOk);
                            cancelBtn.removeEventListener('click', onCancel);
                            document.getElementById('confirmModal').removeEventListener('hidden.bs.modal', onCancel);
                            resolve(result);
                        }
                        function onOk() {
                            modal.hide();
                            cleanup(true);
                        }
                        function onCancel() {
                            cleanup(false);
                        }
                        okBtn.addEventListener('click', onOk);
                        cancelBtn.addEventListener('click', onCancel);
                        document.getElementById('confirmModal').addEventListener('hidden.bs.modal', onCancel);
                        modal.show();
                    });
                }

                // --- Mass Task Editor ---
                let massEditorEditMode = false;
                let massEditorSelectedTasks = new Set();
                let massEditorCurrentUser = null;
                let massEditorFilteredTasks = [];
                let massEditorFilter = { type: "all" };

                function setupMassEditorTab() {
                    const isAdmin = currentUser === "admin";
                    const userSelectContainer = document.getElementById("mass-editor-user-select-container");
                    const userSelect = document.getElementById("mass-editor-user-select");
                    userSelectContainer.style.display = isAdmin ? "" : "none";
                    if (isAdmin) {
                        // Populate user select
                        userSelect.innerHTML = "";
                        Object.keys(getUsers()).forEach(u => {
                            const opt = document.createElement("option");
                            opt.value = u;
                            opt.textContent = u;
                            userSelect.appendChild(opt);
                        });
                        // Default to first user if not set
                        if (!massEditorCurrentUser || !getUsers()[massEditorCurrentUser]) {
                            massEditorCurrentUser = userSelect.options[0].value;
                        }
                        userSelect.value = massEditorCurrentUser;
                        userSelect.onchange = () => {
                            massEditorCurrentUser = userSelect.value;
                            applyMassEditorFilter();
                        };
                    } else {
                        massEditorCurrentUser = currentUser;
                    }
                    applyMassEditorFilter();
                }

                function applyMassEditorFilter() {
                    const tasks = getTasks();
                    const user = tasks[massEditorCurrentUser] || { today: [], archive: {} };
                    let allTasks = [];
                    // Always collect today tasks
                    (user.today || []).forEach(t => allTasks.push({ ...t, date: t.date }));
                    // Always collect archive tasks
                    Object.entries(user.archive || {}).forEach(([date, arr]) => {
                        (arr || []).forEach(t => allTasks.push({ ...t, date }));
                    });
                    let filtered = allTasks;
                    if (massEditorFilter.type === "month" && massEditorFilter.value) {
                        const [yyyy, mm] = massEditorFilter.value.split("-");
                        filtered = filtered.filter(t => t.date && t.date.startsWith(`${yyyy}-${mm}`));
                    } else if (massEditorFilter.type === "week" && massEditorFilter.value) {
                        const [yyyy, ww] = massEditorFilter.value.split("-W");
                        const firstDay = new Date(yyyy, 0, 1 + (ww - 1) * 7);
                        while (firstDay.getDay() !== 1) firstDay.setDate(firstDay.getDate() - 1);
                        const lastDay = new Date(firstDay);
                        lastDay.setDate(firstDay.getDate() + 6);
                        filtered = filtered.filter(t => {
                            const d = new Date(t.date);
                            return d >= firstDay && d <= lastDay;
                        });
                    } else if (massEditorFilter.type === "range" && massEditorFilter.value) {
                        // Multidate: filter by selected dates
                        const selected = massEditorFilter.value || [];
                        filtered = filtered.filter(t => selected.includes(t.date));
                    } else if (massEditorFilter.type === "daterange" && massEditorFilter.value) {
                        const [start, end] = massEditorFilter.value;
                        filtered = filtered.filter(t => t.date >= start && t.date <= end);
                    }
                    filtered.sort((a, b) => a.date.localeCompare(b.date));
                    massEditorFilteredTasks = filtered;
                    renderMassEditorTasks();
                }

                function renderMassEditorTasks() {
                    const container = document.getElementById("mass-editor-tasks-list");
                    container.innerHTML = "";
                    if (massEditorFilteredTasks.length === 0) {
                        container.innerHTML = "<p><em>No tasks found.</em></p>";
                        return;
                    }
                    massEditorFilteredTasks.forEach((taskObj, idx) => {
                        const div = document.createElement("div");
                        div.className = "task-item";
                        if (massEditorEditMode) div.classList.add("edit-mode");

                        if (massEditorEditMode) {
                            // Checkbox for selection
                            const checkbox = document.createElement("input");
                            checkbox.type = "checkbox";
                            checkbox.className = "task-checkbox";
                            checkbox.checked = massEditorSelectedTasks.has(idx);
                            checkbox.addEventListener("change", () => {
                                if (checkbox.checked) massEditorSelectedTasks.add(idx);
                                else massEditorSelectedTasks.delete(idx);
                            });
                            div.appendChild(checkbox);

                            // Editable origin dropdown
                            const origins = getOrigins().filter(o => !o.archived);
                            const originSelect = document.createElement("select");
                            originSelect.className = "form-select form-select-sm me-2";
                            originSelect.style.maxWidth = "120px";
                            origins.forEach(o => {
                                const opt = document.createElement("option");
                                opt.value = o.value;
                                opt.textContent = o.value;
                                if (taskObj.origin === o.value) opt.selected = true;
                                originSelect.appendChild(opt);
                            });
                            originSelect.value = taskObj.origin;
                            originSelect.addEventListener("change", () => {
                                updateMassEditorTask(idx, { origin: originSelect.value });
                            });
                            div.appendChild(originSelect);

                            // Editable input for activity
                            const activityInput = document.createElement("input");
                            activityInput.type = "text";
                            activityInput.value = taskObj.activity;
                            activityInput.className = "form-control form-control-sm me-2";
                            activityInput.style.maxWidth = "180px";
                            activityInput.addEventListener("change", () => {
                                updateMassEditorTask(idx, { activity: activityInput.value.trim() });
                            });
                            div.appendChild(activityInput);

                            // Editable input for remarks
                            const remarksInput = document.createElement("input");
                            remarksInput.type = "text";
                            remarksInput.value = taskObj.remarks || "";
                            remarksInput.className = "form-control form-control-sm me-2";
                            remarksInput.style.maxWidth = "180px";
                            remarksInput.addEventListener("change", () => {
                                updateMassEditorTask(idx, { remarks: remarksInput.value.trim() });
                            });
                            div.appendChild(remarksInput);

                            // Editable input for date
                            const dateInput = document.createElement("input");
                            dateInput.type = "text";
                            dateInput.value = taskObj.date;
                            dateInput.style.width = "120px";
                            $(dateInput).datepicker({
                                format: 'yyyy-mm-dd',
                                autoclose: true,
                                todayHighlight: true,
                                orientation: "bottom auto"
                            }).on('changeDate', function (e) {
                                updateMassEditorTask(idx, { date: e.format('yyyy-mm-dd') });
                            });
                            div.appendChild(dateInput);

                            // Edit/Delete icons
                            const icons = document.createElement("span");
                            icons.className = "task-edit-icons";

                            // Edit icon (focus input)
                            const editBtn = document.createElement("button");
                            editBtn.className = "btn btn-sm btn-outline-primary";
                            editBtn.textContent = "Edit";
                            editBtn.addEventListener("click", () => {
                                activityInput.focus();
                            });
                            icons.appendChild(editBtn);

                            // Delete icon (delete this task)
                            const delBtn = document.createElement("button");
                            delBtn.className = "btn btn-sm btn-outline-danger";
                            delBtn.textContent = "Delete";
                            delBtn.addEventListener("click", async () => {
                                await deleteMassEditorTask(idx);
                            });
                            icons.appendChild(delBtn);

                            div.appendChild(icons);
                        } else {
                            // Not in edit mode: show all fields
                            div.innerHTML = `<strong>${taskObj.origin}</strong> | <span>${taskObj.activity}</span> | <em>${taskObj.remarks || ""}</em> <span class="text-muted">(${taskObj.date})</span>`;
                        }

                        container.appendChild(div);
                    });
                }

                function updateMassEditorTask(idx, changes) {
                    const tasks = getTasks();
                    const user = tasks[massEditorCurrentUser];
                    let task = massEditorFilteredTasks[idx];
                    // Find and update in correct array
                    let found = false;
                    if (user.today) {
                        let tIdx = user.today.findIndex(t => t.origin === task.origin && t.activity === task.activity && t.remarks === task.remarks && t.date === task.date);
                        if (tIdx > -1) {
                            Object.assign(user.today[tIdx], changes);
                            found = true;
                        }
                    }
                    if (!found && user.archive) {
                        Object.keys(user.archive).forEach(date => {
                            let arr = user.archive[date];
                            let tIdx = arr.findIndex(t => t.origin === task.origin && t.activity === task.activity && t.remarks === task.remarks && t.date === task.date);
                            if (tIdx > -1) {
                                Object.assign(arr[tIdx], changes);
                                // If date changed, move to correct archive/today
                                if (changes.date && changes.date !== date) {
                                    const movedTask = arr.splice(tIdx, 1)[0];
                                    movedTask.date = changes.date;
                                    const todayStr = (new Date()).toISOString().slice(0, 10);
                                    if (changes.date === todayStr) {
                                        user.today.push(movedTask);
                                    } else {
                                        if (!user.archive[changes.date]) user.archive[changes.date] = [];
                                        user.archive[changes.date].push(movedTask);
                                    }
                                }
                                found = true;
                            }
                        });
                    }
                    saveTasks(tasks);
                    applyMassEditorFilter();
                }

                async function deleteMassEditorTask(idx) {
                    const confirmed = await showConfirmModal("Are you sure you want to delete this task?");
                    if (!confirmed) return;
                    const tasks = getTasks();
                    const user = tasks[massEditorCurrentUser];
                    let task = massEditorFilteredTasks[idx];
                    let found = false;
                    if (user.today) {
                        let tIdx = user.today.findIndex(t => t.origin === task.origin && t.activity === task.activity && t.remarks === task.remarks && t.date === task.date);
                        if (tIdx > -1) {
                            user.today.splice(tIdx, 1);
                            found = true;
                        }
                    }
                    if (!found && user.archive) {
                        Object.keys(user.archive).forEach(date => {
                            let arr = user.archive[date];
                            let tIdx = arr.findIndex(t => t.origin === task.origin && t.activity === task.activity && t.remarks === task.remarks && t.date === task.date);
                            if (tIdx > -1) {
                                arr.splice(tIdx, 1);
                            }
                        });
                    }
                    saveTasks(tasks);
                    applyMassEditorFilter();
                }

                // Mass delete
                document.getElementById("mass-editor-delete-selected-btn").addEventListener("click", async () => {
                    if (massEditorSelectedTasks.size === 0) {
                        alert("No tasks selected.");
                        return;
                    }
                    const confirmed = await showConfirmModal("Are you sure you want to delete the selected tasks?");
                    if (!confirmed) return;
                    // Delete in reverse order to avoid reindexing
                    const idxs = Array.from(massEditorSelectedTasks).sort((a, b) => b - a);
                    for (const idx of idxs) {
                        await deleteMassEditorTask(idx);
                    }
                    massEditorSelectedTasks.clear();
                    applyMassEditorFilter();
                });

                // Edit mode toggle
                document.getElementById("mass-editor-edit-btn").addEventListener("click", () => {
                    if (!massEditorEditMode) {
                        massEditorEditMode = true;
                        document.getElementById("mass-editor-edit-btn-label").textContent = "DONE";
                        document.getElementById("mass-editor-delete-selected-btn").style.display = "";
                        massEditorSelectedTasks.clear();
                        renderMassEditorTasks();
                    } else {
                        massEditorEditMode = false;
                        document.getElementById("mass-editor-edit-btn-label").textContent = "EDIT";
                        document.getElementById("mass-editor-delete-selected-btn").style.display = "none";
                        massEditorSelectedTasks.clear();
                        renderMassEditorTasks();
                    }
                });

                // Filter UI logic
                document.getElementById("mass-editor-filter-type").addEventListener("change", function () {
                    document.getElementById("mass-editor-filter-month").style.display = this.value === "month" ? "" : "none";
                    document.getElementById("mass-editor-filter-week").style.display = this.value === "week" ? "" : "none";
                    document.getElementById("mass-editor-filter-range").style.display = this.value === "range" ? "" : "none";
                                       document.getElementById("mass-editor-filter-daterange").style.display = this.value === "daterange" ? "" : "none";
                });
               
                $('#mass-editor-range').datepicker({
                    format: 'yyyy-mm-dd',
                    multidate: true,
                    todayHighlight: true,
                    autoclose: false,
                    orientation: "bottom auto"
                });

                // Mass Editor: Date range picker
                $('.input-daterange input').datepicker({
                    format: 'yyyy-mm-dd',
                    todayHighlight: true,
                    autoclose: true,
                    orientation: "bottom auto"
                });
                document.getElementById("mass-editor-apply-filter-btn").addEventListener("click", function () {
                    const type = document.getElementById("mass-editor-filter-type").value;
                    massEditorFilter.type = type;
                    if (type === "month") {
                        massEditorFilter.value = document.getElementById("mass-editor-month").value;
                    } else if (type === "week") {
                        massEditorFilter.value = document.getElementById("mass-editor-week").value;
                    } else if (type === "range") {
                        // Multidate: get selected dates as array
                        massEditorFilter.value = $('#mass-editor-range').datepicker('getDates').map(d =>
                            d.toISOString().slice(0, 10)
                        );
                    } else if (type === "daterange") {
                        // Date range: get start and end
                        const start = document.getElementById("mass-editor-range-start").value;
                        const end = document.getElementById("mass-editor-range-end").value;
                        massEditorFilter.value = [start, end];
                    } else {
                        massEditorFilter.value = null;
                    }
                    applyMassEditorFilter();
                });

                // --- Backup, Import, Export Section ---

                // Helper: UUID generator (simple, not cryptographically secure)
                function uuidv4() {
                    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                        var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                        return v.toString(16);
                    });
                }

                // Ensure all users and tasks have unique IDs
                function ensureUserAndTaskIDs() {
                    const users = getUsers();
                    let changed = false;
                    Object.keys(users).forEach(username => {
                        if (!users[username].id) {
                            users[username].id = uuidv4();
                            changed = true;
                        }
                    });
                    if (changed) saveUsers(users);

                    const tasks = getTasks();
                    Object.keys(tasks).forEach(username => {
                        // Today
                        if (Array.isArray(tasks[username].today)) {
                            tasks[username].today.forEach(task => {
                                if (!task.id) task.id = uuidv4();
                            });
                        }
                        // Archive
                        if (tasks[username].archive) {
                            Object.values(tasks[username].archive).forEach(arr => {
                                arr.forEach(task => {
                                    if (!task.id) task.id = uuidv4();
                                });
                            });
                        }
                    });
                    saveTasks(tasks);
                }

                // Call this after login
                function afterLoginSetupWithIDs() {
                    ensureUserAndTaskIDs();
                    afterLoginSetup();
                }

                // Replace afterLoginSetup() with afterLoginSetupWithIDs() in your login logic:
                loginBtn.addEventListener("click", () => {
                    const username = document.getElementById("login-username").value.trim();
                    const password = document.getElementById("login-password").value;
                    if (!username || !password) {
                        loginError.textContent = "Please enter username and password.";
                        return;
                    }
                    if (validateLogin(username, password)) {
                        currentUser = username;
                        sessionStorage.setItem(SESSION_USER_KEY, currentUser);
                        loginError.textContent = "";
                        afterLoginSetupWithIDs(); // <--- use this
                    } else {
                        loginError.textContent = "Invalid username or password.";
                    }
                });

                // --- UI logic for Backup/Import/Export ---
                function setupBackupTab() {
                    const isAdmin = currentUser === "admin";
                    document.getElementById("backup-admin-section").style.display = isAdmin ? "" : "none";
                }

                // Show tab logic
                document.getElementById('sidebar-backup-btn').addEventListener('shown.bs.tab', function () {
                    setupBackupTab();
                });

                // --- Export My Tasks ---
                document.getElementById("export-my-tasks-btn").addEventListener("click", function () {
                    const users = getUsers();
                    const tasks = getTasks();
                    const user = users[currentUser];
                    const userTasks = tasks[currentUser] || { today: [], archive: {} };
                    const data = {
                        user: { id: user.id, username: currentUser },
                        tasks: userTasks
                    };
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `${currentUser}-tasks-backup-${(new Date()).toISOString().slice(0,10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });

                // --- Import My Tasks ---
                document.getElementById("import-my-tasks-btn").addEventListener("click", function () {
                    document.getElementById("import-my-tasks-input").click();
                });
                document.getElementById("import-my-tasks-input").addEventListener("change", function (e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = function(evt) {
                        try {
                            const data = JSON.parse(evt.target.result);
                            const users = getUsers();
                            if (!data.user || !data.user.id || data.user.id !== users[currentUser].id) {
                                document.getElementById("import-my-tasks-status").textContent = "User ID does not match. Import aborted.";
                                return;
                            }
                            // Ask to overwrite or merge
                            if (confirm("Overwrite all your tasks with imported data? Click Cancel to merge (only new tasks will be added).")) {
                                // Overwrite
                                const tasks = getTasks();
                                tasks[currentUser] = data.tasks;
                                saveTasks(tasks);
                                document.getElementById("import-my-tasks-status").textContent = "Tasks imported (overwritten).";
                            } else {
                                // Merge: only add tasks with new IDs
                                const tasks = getTasks();
                                const existingIDs = new Set();
                                tasks[currentUser].today.forEach(t => existingIDs.add(t.id));
                                Object.values(tasks[currentUser].archive).forEach(arr => arr.forEach(t => existingIDs.add(t.id)));
                                // Today
                                data.tasks.today.forEach(t => {
                                    if (!existingIDs.has(t.id)) tasks[currentUser].today.push(t);
                                });
                                // Archive
                                Object.entries(data.tasks.archive).forEach(([date, arr]) => {
                                    if (!tasks[currentUser].archive[date]) tasks[currentUser].archive[date] = [];
                                    arr.forEach(t => {
                                        if (!existingIDs.has(t.id)) tasks[currentUser].archive[date].push(t);
                                    });
                                });
                                saveTasks(tasks);
                                document.getElementById("import-my-tasks-status").textContent = "Tasks imported (merged).";
                            }
                        } catch (err) {
                            document.getElementById("import-my-tasks-status").textContent = "Import failed: " + err;
                        }
                    };
                    reader.readAsText(file);
                });

                // --- Export All Users (Admin) ---
                document.getElementById("export-all-users-btn").addEventListener("click", async function () {
                    const users = getUsers();
                    const tasks = getTasks();
                    const zip = new JSZip();
                    Object.keys(users).forEach(username => {
                        const userData = {
                            user: { id: users[username].id, username },
                            tasks: tasks[username] || { today: [], archive: {} }
                        };
                        zip.file(`${username}.json`, JSON.stringify(userData, null, 2));
                    });
                    const blob = await zip.generateAsync({ type: "blob" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `all-users-tasks-backup-${(new Date()).toISOString().slice(0,10)}.zip`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });

                // --- Import All Users (Admin) ---
                document.getElementById("import-all-users-btn").addEventListener("click", function () {
                    document.getElementById("import-all-users-input").click();
                });
                document.getElementById("import-all-users-input").addEventListener("change", async function (e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    const statusDiv = document.getElementById("import-all-users-status");
                    statusDiv.textContent = "";
                    if (file.name.endsWith(".zip")) {
                        // ZIP: multiple users
                        const zip = await JSZip.loadAsync(file);
                        const users = getUsers();
                        const tasks = getTasks();
                        let importSummary = [];
                        for (const filename of Object.keys(zip.files)) {
                            if (!filename.endsWith(".json")) continue;
                            const content = await zip.files[filename].async("string");
                            try {
                                const data = JSON.parse(content);
                                if (!data.user || !data.user.id || !data.user.username) continue;
                                const uname = data.user.username;
                                // Ask admin for each user
                                let action = "skip";
                                if (users[uname]) {
                                    action = prompt(`User "${uname}" exists. Type "overwrite" to overwrite, "merge" to merge, or anything else to skip.`, "merge");
                                } else {
                                    action = prompt(`User "${uname}" does not exist. Type "create" to add, or anything else to skip.`, "create");
                                }
                                if (action === "overwrite") {
                                    users[uname] = { ...users[uname], id: data.user.id };
                                    tasks[uname] = data.tasks;
                                    importSummary.push(`User ${uname}: overwritten`);
                                } else if (action === "merge") {
                                    if (!users[uname]) users[uname] = { id: data.user.id, password: "" };
                                    if (!tasks[uname]) tasks[uname] = { today: [], archive: {} };
                                    const existingIDs = new Set();
                                    tasks[uname].today.forEach(t => existingIDs.add(t.id));
                                    Object.values(tasks[uname].archive).forEach(arr => arr.forEach(t => existingIDs.add(t.id)));
                                    // Today
                                    data.tasks.today.forEach(t => {
                                        if (!existingIDs.has(t.id)) tasks[uname].today.push(t);
                                    });
                                    // Archive
                                    Object.entries(data.tasks.archive).forEach(([date, arr]) => {
                                        if (!tasks[uname].archive[date]) tasks[uname].archive[date] = [];
                                        arr.forEach(t => {
                                            if (!existingIDs.has(t.id)) tasks[uname].archive[date].push(t);
                                        });
                                    });
                                    importSummary.push(`User ${uname}: merged`);
                                } else if (action === "create") {
                                    users[uname] = { id: data.user.id, password: "" };
                                    tasks[uname] = data.tasks;
                                    importSummary.push(`User ${uname}: created`);
                                } else {
                                    importSummary.push(`User ${uname}: skipped`);
                                }
                            } catch (err) {
                                importSummary.push(`${filename}: import failed (${err})`);
                            }
                        }
                        saveUsers(users);
                        saveTasks(tasks);
                        statusDiv.innerHTML = importSummary.map(s => `<div>${s}</div>`).join("");
                    } else if (file.name.endsWith(".json")) {
                        // Single user JSON
                        const reader = new FileReader();
                        reader.onload = function(evt) {
                            try {
                                const data = JSON.parse(evt.target.result);
                                if (!data.user || !data.user.id || !data.user.username) {
                                    statusDiv.textContent = "Invalid file.";
                                    return;
                                }
                                const uname = data.user.username;
                                const users = getUsers();
                                const tasks = getTasks();
                                let action = "skip";
                                if (users[uname]) {
                                    action = prompt(`User "${uname}" exists. Type "overwrite" to overwrite, "merge" to merge, or anything else to skip.`, "merge");
                                } else {
                                    action = prompt(`User "${uname}" does not exist. Type "create" to add, or anything else to skip.`, "create");
                                }
                                if (action === "overwrite") {
                                    users[uname] = { ...users[uname], id: data.user.id };
                                    tasks[uname] = data.tasks;
                                    statusDiv.textContent = `User ${uname}: overwritten`;
                                } else if (action === "merge") {
                                    if (!users[uname]) users[uname] = { id: data.user.id, password: "" };
                                    if (!tasks[uname]) tasks[uname] = { today: [], archive: {} };
                                    const existingIDs = new Set();
                                    tasks[uname].today.forEach(t => existingIDs.add(t.id));
                                    Object.values(tasks[uname].archive).forEach(arr => arr.forEach(t => existingIDs.add(t.id)));
                                    // Today
                                    data.tasks.today.forEach(t => {
                                        if (!existingIDs.has(t.id)) tasks[uname].today.push(t);
                                    });
                                    // Archive
                                    Object.entries(data.tasks.archive).forEach(([date, arr]) => {
                                        if (!tasks[uname].archive[date]) tasks[uname].archive[date] = [];
                                        arr.forEach(t => {
                                            if (!existingIDs.has(t.id)) tasks[uname].archive[date].push(t);
                                        });
                                    });
                                    statusDiv.textContent = `User ${uname}: merged`;
                                } else if (action === "create") {
                                    users[uname] = { id: data.user.id, password: "" };
                                    tasks[uname] = data.tasks;
                                    statusDiv.textContent = `User ${uname}: created`;
                                } else {
                                    statusDiv.textContent = `User ${uname}: skipped`;
                                }
                                saveUsers(users);
                                saveTasks(tasks);
                            } catch (err) {
                                statusDiv.textContent = "Import failed: " + err;
                            }
                        };
                        reader.readAsText(file);
                    } else {
                        statusDiv.textContent = "Unsupported file type.";
                    }
                });
            })();
        </script>
</body>

</html>