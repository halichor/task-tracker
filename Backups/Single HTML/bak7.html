<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Task Manager with Users & Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css"
        rel="stylesheet" />
    <style>
        body {
            padding: 1rem;
            background: #f8f9fa;
        }

        #app {
            display: none;
        }

        .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.3rem;
            padding: 0.3rem 0.5rem;
            background: #fff;
            border-radius: 4px;
            box-shadow: 0 0 3px #ddd;
        }

        .task-item input[type="text"] {
            border: none;
            background: transparent;
            width: 100%;
        }

        .task-item input[type="text"]:focus {
            outline: 1px solid #0d6efd;
            background: #e7f1ff;
        }

        .nav-link.disabled {
            cursor: not-allowed;
        }

        .task-drag-handle {
            cursor: move;
            margin-right: 0.5rem;
        }

        .edit-mode {
            background: #e7f1ff;
        }

        .task-drag-handle {
            cursor: grab;
            margin-right: 0.5rem;
            font-size: 1.2em;
            color: #888;
            user-select: none;
        }

        .task-edit-icons {
            display: flex;
            gap: 0.3rem;
            margin-left: 0.5rem;
        }

        .task-checkbox {
            margin-right: 0.5rem;
        }

        .task-item.edit-mode {
            background: #f1f8ff;
        }
    </style>
</head>

<body>

    <!-- LOGIN SCREEN -->
    <div id="auth" class="container" style="max-width: 400px;">
        <h3 class="mb-4">Please Log In</h3>
        <div class="mb-3">
            <input type="text" id="login-username" class="form-control" placeholder="Username"
                autocomplete="username" />
        </div>
        <div class="mb-3">
            <input type="password" id="login-password" class="form-control" placeholder="Password"
                autocomplete="current-password" />
        </div>
        <button id="login-btn" class="btn btn-primary w-100">Login</button>
        <div id="login-error" class="text-danger mt-3"></div>
    </div>

    <!-- MAIN APP -->
    <div id="app" class="container">

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3>Task Manager - User: <span id="current-user-name"></span></h3>
            <button id="logout-btn" class="btn btn-outline-secondary">Logout</button>
        </div>

        <ul class="nav nav-tabs mb-3" id="main-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="today-tab" data-bs-toggle="tab" data-bs-target="#today"
                    type="button" role="tab">Today</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="archive-tab" data-bs-toggle="tab" data-bs-target="#archive" type="button"
                    role="tab">Archive</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="view-users-tab" data-bs-toggle="tab" data-bs-target="#view-users"
                    type="button" role="tab">View Tasks</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button"
                    role="tab">Settings</button>
            </li>
        </ul>

        <div class="tab-content" id="main-tabs-content">
            <!-- Today Tab -->
            <div class="tab-pane fade show active" id="today" role="tabpanel" aria-labelledby="today-tab">
                <div class="mb-3 d-flex gap-2">
                    <input type="text" id="task-input" class="form-control" placeholder="Enter a task for today" />
                    <input type="text" id="task-date-input" class="form-control" style="max-width:160px;" />
                </div>
                <button class="btn btn-primary mb-3" id="add-task-btn">Add Task</button>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="mb-0">Today's Tasks</h5>
                    <div id="today-edit-controls" style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-outline-secondary btn-sm" id="today-edit-btn">
                            <span id="today-edit-btn-label">EDIT</span>
                        </button>
                        <button class="btn btn-danger btn-sm" id="today-delete-selected-btn" style="display:none;">
                            Delete Selected
                        </button>
                    </div>
                </div>
                <div id="today-tasks-list" class="mb-4"></div>
            </div>

            <!-- Archive Tab -->
            <div class="tab-pane fade" id="archive" role="tabpanel" aria-labelledby="archive-tab">
                <div class="mb-3">
                    <div id="datepicker" class="datepicker-inline"></div>

                    <h5>Tasks on <span id="archive-date-display">[select a date]</span></h5>
                    <div id="archive-tasks-list"></div>
                </div>
                <div class="d-flex gap-2 mb-2">
                    <button class="btn btn-outline-secondary btn-sm" id="archive-edit-btn">
                        <span id="archive-edit-btn-label">EDIT</span>
                    </button>
                    <button class="btn btn-danger btn-sm" id="archive-delete-selected-btn" style="display:none;">
                        Delete Selected
                    </button>
                </div>
            </div>

            <!-- View Tasks Tab -->
            <div class="tab-pane fade" id="view-users" role="tabpanel" aria-labelledby="view-users-tab">
                <div class="mb-3">
                    <label for="view-tasks-date" class="form-label">Select Date:</label>
                    <div class="input-group date" id="view-tasks-date-group" data-provide="datepicker"
                        data-date-format="yyyy-mm-dd" data-date-autoclose="true" data-date-today-highlight="true">
                        <input type="text" id="view-tasks-date" class="form-control" readonly
                            style="background:#fff; cursor:pointer; max-width:200px;" />
                        <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                    </div>
                </div>
                <div class="accordion" id="users-tasks-accordion"></div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
                <div class="row">
                    <!-- Sidebar as Bootstrap nav-pills flex-column -->
                    <div class="col-md-4">
                        <ul class="nav nav-pills flex-column mb-3" id="settings-sidebar" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="sidebar-account-btn" data-bs-toggle="pill"
                                    data-bs-target="#account-section" type="button" role="tab">Account Settings</button>
                            </li>
                            <li class="nav-item" role="presentation" id="sidebar-user-mgmt-li" style="display:none;">
                                <button class="nav-link" id="sidebar-user-mgmt-btn" data-bs-toggle="pill"
                                    data-bs-target="#user-mgmt-section" type="button" role="tab">User
                                    Management</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="sidebar-holidays-btn" data-bs-toggle="pill"
                                    data-bs-target="#holidays-section" type="button" role="tab">Holidays</button>
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-8">
                        <div class="tab-content">
                            <!-- Account Settings Tab -->
                            <div class="tab-pane fade show active" id="account-section" role="tabpanel">
                                <h5>Change Username and Password</h5>
                                <div class="mb-3">
                                    <label for="new-username" class="form-label">New Username</label>
                                    <input type="text" id="new-username" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label for="new-password" class="form-label">New Password</label>
                                    <input type="password" id="new-password" class="form-control" />
                                </div>
                                <button class="btn btn-primary" id="save-settings-btn">Save Changes</button>
                            </div>
                            <!-- User Management Tab (admin only) -->
                            <div class="tab-pane fade" id="user-mgmt-section" role="tabpanel">
                                <h5>User Management</h5>
                                <div id="admin-user-mgmt">
                                    <div class="mb-3">
                                        <label for="admin-new-username" class="form-label">New Username</label>
                                        <input type="text" id="admin-new-username" class="form-control" />
                                    </div>
                                    <div class="mb-3">
                                        <label for="admin-new-password" class="form-label">New Password</label>
                                        <input type="password" id="admin-new-password" class="form-control" />
                                    </div>
                                    <button class="btn btn-success mb-3" id="admin-create-user-btn">Create User</button>
                                    <h6>Existing Users</h6>
                                    <ul id="user-list" class="list-group"></ul>
                                </div>
                            </div>
                            <!-- Holidays Tab -->
                            <div class="tab-pane fade" id="holidays-section" role="tabpanel">
                                <h5>Holidays</h5>
                                <div class="mb-3">
                                    <label for="holiday-datepicker" class="form-label">Select Date:</label>
                                    <div id="holiday-datepicker"></div>
                                </div>
                                <div class="mb-3">
                                    <label for="holiday-name" class="form-label">Holiday Name</label>
                                    <input type="text" id="holiday-name" class="form-control"
                                        placeholder="e.g. New Year's Day" />
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="holiday-repeat" />
                                    <label class="form-check-label" for="holiday-repeat">
                                        Repeat every year
                                    </label>
                                </div>
                                <button class="btn btn-primary mb-2" id="add-holiday-btn">Add Holiday</button>
                                <div id="holidays-list"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Confirmation Modal -->
        <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="confirmModalLabel">Please Confirm</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="confirmModalBody">
                        <!-- Message goes here -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" id="confirmModalCancel"
                            data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="confirmModalOk">OK</button>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
        <script>
            (() => {
                // Data keys and current user var
                const LS_USERS_KEY = "tm_users";
                const LS_TASKS_KEY = "tm_tasks";
                const SESSION_USER_KEY = "tm_currentUser";
                let currentUser = null;

                // Elements
                const authDiv = document.getElementById("auth");
                const appDiv = document.getElementById("app");
                const loginBtn = document.getElementById("login-btn");
                const logoutBtn = document.getElementById("logout-btn");
                const loginError = document.getElementById("login-error");
                const currentUserNameSpan = document.getElementById("current-user-name");

                // Tabs elements
                const taskInput = document.getElementById("task-input");
                const addTaskBtn = document.getElementById("add-task-btn");
                const todayTasksList = document.getElementById("today-tasks-list");

                const newUsernameInput = document.getElementById("new-username");
                const newPasswordInput = document.getElementById("new-password");
                const saveSettingsBtn = document.getElementById("save-settings-btn");

                const adminNewUsername = document.getElementById("admin-new-username");
                const adminNewPassword = document.getElementById("admin-new-password");
                const adminCreateUserBtn = document.getElementById("admin-create-user-btn");
                const userListUl = document.getElementById("user-list");

                // Archive
                const archiveDateDisplay = document.getElementById("archive-date-display");
                const archiveTasksList = document.getElementById("archive-tasks-list");

                // --- Helpers ---
                function getUsers() {
                    let users = JSON.parse(localStorage.getItem(LS_USERS_KEY));
                    if (!users) {
                        users = { admin: { password: "adminpass" } };
                        localStorage.setItem(LS_USERS_KEY, JSON.stringify(users));
                    }
                    return users;
                }
                function saveUsers(users) {
                    localStorage.setItem(LS_USERS_KEY, JSON.stringify(users));
                }
                function getTasks() {
                    return JSON.parse(localStorage.getItem(LS_TASKS_KEY)) || {};
                }
                function saveTasks(tasks) {
                    localStorage.setItem(LS_TASKS_KEY, JSON.stringify(tasks));
                }
                const LS_HOLIDAYS_KEY = "tm_holidays";
                function getHolidays() {
                    return JSON.parse(localStorage.getItem(LS_HOLIDAYS_KEY)) || [];
                }
                function saveHolidays(holidays) {
                    localStorage.setItem(LS_HOLIDAYS_KEY, JSON.stringify(holidays));
                }
                function renderHolidaysList() {
                    const holidays = getHolidays();
                    const listDiv = document.getElementById('holidays-list');
                    if (!holidays.length) {
                        listDiv.innerHTML = "<em>No holidays set.</em>";
                        return;
                    }
                    const ul = document.createElement('ul');
                    ul.className = "list-group";
                    holidays.forEach((h, idx) => {
                        const li = document.createElement('li');
                        li.className = "list-group-item d-flex justify-content-between align-items-center";
                        li.textContent = `${h.name} (${h.date})${h.repeat ? " [Repeats]" : ""}`;
                        const delBtn = document.createElement('button');
                        delBtn.className = "btn btn-sm btn-danger";
                        delBtn.textContent = "Delete";
                        delBtn.onclick = () => {
                            const arr = getHolidays();
                            arr.splice(idx, 1);
                            saveHolidays(arr);
                            renderHolidaysList();
                        };
                        li.appendChild(delBtn);
                        ul.appendChild(li);
                    });
                    listDiv.innerHTML = "";
                    listDiv.appendChild(ul);
                }
                function ensureAllUsersTaskStructure() {
                    const users = getUsers();
                    const tasks = getTasks();
                    let changed = false;
                    Object.keys(users).forEach(username => {
                        if (!tasks[username]) {
                            tasks[username] = { today: [], archive: {} };
                            changed = true;
                        } else {
                            if (!tasks[username].today) {
                                tasks[username].today = [];
                                changed = true;
                            }
                            if (!tasks[username].archive) {
                                tasks[username].archive = {};
                                changed = true;
                            }
                        }
                    });
                    if (changed) saveTasks(tasks);
                }

                function migrateTasksToObjects() {
                    const tasks = getTasks();
                    let changed = false;
                    Object.keys(tasks).forEach(username => {
                        if (tasks[username].today) {
                            tasks[username].today = tasks[username].today.map(t =>
                                typeof t === "string" ? { text: t, date: (new Date()).toISOString().slice(0, 10) } : t
                            );
                            changed = true;
                        }
                        if (tasks[username].archive) {
                            Object.keys(tasks[username].archive).forEach(date => {
                                tasks[username].archive[date] = tasks[username].archive[date].map(t =>
                                    typeof t === "string" ? { text: t, date: date } : t
                                );
                                changed = true;
                            });
                        }
                    });
                    if (changed) saveTasks(tasks);
                }

                $(document).ready(function () {
                    // HOLIDAY datepicker
                    $('#holiday-datepicker').datepicker({
                        format: 'yyyy-mm-dd',
                        todayHighlight: true,
                        autoclose: true,
                        orientation: "bottom auto"
                    });
                    // TODAY datepicker
                    $('#task-date-input').datepicker({
                        format: 'yyyy-mm-dd',
                        todayHighlight: true,
                        autoclose: true,
                        orientation: "bottom auto"
                    });
                    $('#task-date-input').datepicker('setDate', new Date());
                    // ARCHIVE datepicker
                    $('#datepicker').datepicker({
                        format: 'yyyy-mm-dd',
                        todayHighlight: true,
                        autoclose: true,
                        orientation: "bottom auto"
                    }).on('changeDate', function (e) {
                        const date = e.format('yyyy-mm-dd');
                        document.getElementById('archive-date-display').textContent = date;
                        loadArchiveDate(new Date(date));
                    });
                    // VIEW TASKS datepicker
                    $('#view-tasks-date-group').datepicker({
                        format: 'yyyy-mm-dd',
                        todayHighlight: true,
                        autoclose: true,
                        orientation: "bottom auto"
                    }).on('changeDate', function (e) {
                        const date = e.format('yyyy-mm-dd');
                        $('#view-tasks-date').val(date);
                        loadUsersTasksForDate(date);
                    });
                    // Set initial date for view tasks
                    const today = new Date();
                    const todayStr = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
                    $('#view-tasks-date').val(todayStr);
                    loadUsersTasksForDate(todayStr);
                    // Set initial archive date display
                    const todayArchive = new Date();
                    const todayArchiveStr = todayArchive.getFullYear() + '-' + String(todayArchive.getMonth() + 1).padStart(2, '0') + '-' + String(todayArchive.getDate()).padStart(2, '0');
                    $('#datepicker').datepicker('setDate', todayArchiveStr);
                    document.getElementById('archive-date-display').textContent = todayArchiveStr;
                    renderHolidaysList();
                });

                // Add holiday
                document.getElementById('add-holiday-btn').addEventListener('click', function () {
                    const date = $('#holiday-datepicker').datepicker('getFormattedDate');
                    const name = document.getElementById('holiday-name').value.trim();
                    const repeat = document.getElementById('holiday-repeat').checked;
                    if (!date || !name) {
                        alert("Please select a date and enter a holiday name.");
                        return;
                    }
                    const holidays = getHolidays();
                    holidays.push({ date, name, repeat });
                    saveHolidays(holidays);
                    renderHolidaysList();
                    document.getElementById('holiday-name').value = "";
                    document.getElementById('holiday-repeat').checked = false;
                });

                // --- Login ---
                function validateLogin(username, password) {
                    const users = getUsers();
                    return users[username] && users[username].password === password;
                }

                loginBtn.addEventListener("click", () => {
                    const username = document.getElementById("login-username").value.trim();
                    const password = document.getElementById("login-password").value;

                    if (!username || !password) {
                        loginError.textContent = "Please enter username and password.";
                        return;
                    }
                    if (validateLogin(username, password)) {
                        currentUser = username;
                        sessionStorage.setItem(SESSION_USER_KEY, currentUser);
                        loginError.textContent = "";
                        ensureAllUsersTaskStructure(); // <-- Use this
                        authDiv.style.display = "none";
                        appDiv.style.display = "block";
                        currentUserNameSpan.textContent = currentUser;
                        setupAdminTab();
                        loadTodayTasks();
                        loadArchiveDate(new Date());
                        clearLoginInputs();
                        clearSettingsInputs();
                    } else {
                        loginError.textContent = "Invalid username or password.";
                    }
                });

                logoutBtn.addEventListener("click", () => {
                    currentUser = null;
                    sessionStorage.removeItem(SESSION_USER_KEY);
                    authDiv.style.display = "block";
                    appDiv.style.display = "none";
                    clearLoginInputs();
                    clearSettingsInputs();
                    clearTasksDisplay();
                    clearAdminUserList();
                });

                function clearLoginInputs() {
                    document.getElementById("login-username").value = "";
                    document.getElementById("login-password").value = "";
                    loginError.textContent = "";
                }
                function clearSettingsInputs() {
                    newUsernameInput.value = "";
                    newPasswordInput.value = "";
                }
                function clearTasksDisplay() {
                    todayTasksList.innerHTML = "";
                    archiveTasksList.innerHTML = "";
                    document.getElementById("users-tasks-accordion").innerHTML = "";
                }
                function clearAdminUserList() {
                    userListUl.innerHTML = "";
                }

                // --- Admin Tab setup ---
                function setupAdminTab() {
                    const isAdmin = currentUser === "admin";
                    // Only show User Management in settings for admin
                    const userMgmtLi = document.getElementById('sidebar-user-mgmt-li');
                    const adminUserMgmt = document.getElementById('admin-user-mgmt');
                    if (userMgmtLi) userMgmtLi.style.display = isAdmin ? "" : "none";
                    if (adminUserMgmt) adminUserMgmt.style.display = isAdmin ? "" : "none";
                    if (isAdmin) loadAdminUserList();
                }

                function loadAdminUserList() {
                    const users = getUsers();
                    userListUl.innerHTML = "";
                    Object.keys(users).forEach(username => {
                        if (username === "admin") return; // Don't show admin in the list
                        const li = document.createElement("li");
                        li.className = "list-group-item d-flex justify-content-between align-items-center";
                        li.textContent = username;
                        const delBtn = document.createElement("button");
                        delBtn.className = "btn btn-sm btn-danger";
                        delBtn.textContent = "Delete";
                        delBtn.onclick = async () => {
                            if (confirm(`Delete user "${username}"? This cannot be undone.`)) {
                                const users = getUsers();
                                const tasks = getTasks();
                                delete users[username];
                                delete tasks[username];
                                saveUsers(users);
                                saveTasks(tasks);
                                ensureAllUsersTaskStructure();
                                loadAdminUserList();
                            }
                        };
                        li.appendChild(delBtn);
                        userListUl.appendChild(li);
                    });
                }

                adminCreateUserBtn.addEventListener("click", () => {
                    const username = adminNewUsername.value.trim();
                    const password = adminNewPassword.value;
                    if (!username || !password) {
                        alert("Please enter a username and password.");
                        return;
                    }
                    const users = getUsers();
                    if (users[username]) {
                        alert("User already exists.");
                        return;
                    }
                    users[username] = { password };
                    saveUsers(users);
                    ensureAllUsersTaskStructure();
                    adminNewUsername.value = "";
                    adminNewPassword.value = "";
                    loadAdminUserList();
                });

                // --- Tasks functions ---
                function loadTodayTasks() {
                    const tasks = getTasks();
                    const todayStr = (new Date()).toISOString().slice(0, 10);
                    let userTasks = (tasks[currentUser] && tasks[currentUser].today) || [];
                    // Only show tasks with today's date
                    userTasks = userTasks.filter(t => t.date === todayStr);
                    renderTaskList(userTasks, todayTasksList, true, todayStr);
                }

                function addTaskToToday(taskText) {
                    if (!taskText.trim()) return;
                    const tasks = getTasks();
                    if (!tasks[currentUser]) tasks[currentUser] = {};
                    if (!tasks[currentUser].today) tasks[currentUser].today = [];
                    tasks[currentUser].today.push(taskText.trim());
                    saveTasks(tasks);
                }

                function addTaskToDate(taskText, taskDate) {
                    if (!taskText.trim() || !taskDate) return;
                    const tasks = getTasks();
                    if (!tasks[currentUser]) tasks[currentUser] = { today: [], archive: {} };
                    // If date is today, add to today, else to archive
                    const todayStr = (new Date()).toISOString().slice(0, 10);
                    const taskObj = { text: taskText.trim(), date: taskDate };
                    if (taskDate === todayStr) {
                        tasks[currentUser].today.push(taskObj);
                    } else {
                        if (!tasks[currentUser].archive[taskDate]) tasks[currentUser].archive[taskDate] = [];
                        tasks[currentUser].archive[taskDate].push(taskObj);
                    }
                    saveTasks(tasks);
                }

                addTaskBtn.addEventListener("click", () => {
                    const taskText = taskInput.value.trim();
                    const taskDate = document.getElementById("task-date-input").value;
                    if (!taskText || !taskDate) return;
                    addTaskToDate(taskText, taskDate);
                    taskInput.value = "";
                    $('#task-date-input').datepicker('setDate', new Date());
                    loadTodayTasks();
                });

                // Optionally, allow pressing Enter to add task
                taskInput.addEventListener("keydown", (e) => {
                    if (e.key === "Enter") {
                        addTaskBtn.click();
                    }
                });


                // --- Add this helper for holidays ---
                function getHolidayForDate(dateStr) {
                    const holidays = getHolidays();
                    const [yyyy, mm, dd] = dateStr.split('-');
                    return holidays.filter(h => {
                        if (h.repeat) {
                            // Match month and day
                            const [hyyyy, hmm, hdd] = h.date.split('-');
                            return hmm === mm && hdd === dd;
                        }
                        return h.date === dateStr;
                    });
                }

                // Save today's tasks to archive at midnight (or on logout, or when switching days)
                function archiveTodayTasksIfNeeded() {
                    const tasks = getTasks();
                    Object.keys(tasks).forEach(username => {
                        const userData = tasks[username];
                        if (!userData.today || userData.today.length === 0) return;
                        // Get today's date string
                        const todayObj = new Date();
                        const todayStr = `${todayObj.getFullYear()}-${(todayObj.getMonth() + 1).toString().padStart(2, "0")}-${todayObj.getDate().toString().padStart(2, "0")}`;
                        if (!userData.archive) userData.archive = {};
                        // Only archive if not already archived for today
                        if (!userData.archive[todayStr]) {
                            userData.archive[todayStr] = [...userData.today];
                            userData.today = [];
                        }
                    });
                    saveTasks(tasks);
                }

                // --- Today Tab Edit Mode ---
                let todayEditMode = false;
                let todaySelectedTasks = new Set();

                function renderTaskList(tasksArray, container, isEditable, currentDate) {
                    container.innerHTML = "";
                    if (tasksArray.length === 0) {
                        container.innerHTML = "<p><em>No tasks</em></p>";
                        return;
                    }
                    tasksArray.forEach((taskObj, idx) => {
                        const div = document.createElement("div");
                        div.className = "task-item";
                        if (todayEditMode && isEditable) div.classList.add("edit-mode");

                        if (todayEditMode && isEditable) {
                            // Checkbox for selection
                            const checkbox = document.createElement("input");
                            checkbox.type = "checkbox";
                            checkbox.className = "task-checkbox";
                            checkbox.checked = todaySelectedTasks.has(idx);
                            checkbox.addEventListener("change", () => {
                                if (checkbox.checked) todaySelectedTasks.add(idx);
                                else todaySelectedTasks.delete(idx);
                            });
                            div.appendChild(checkbox);

                            // Editable input for text
                            const input = document.createElement("input");
                            input.type = "text";
                            input.value = taskObj.text;
                            input.style.marginRight = "0.5em";
                            input.addEventListener("change", () => {
                                const tasks = getTasks();
                                tasks[currentUser].today[idx].text = input.value.trim();
                                saveTasks(tasks);
                            });
                            div.appendChild(input);

                            // Editable input for date
                            const dateInput = document.createElement("input");
                            dateInput.type = "text";
                            dateInput.value = taskObj.date;
                            dateInput.style.width = "120px";
                            $(dateInput).datepicker({
                                format: 'yyyy-mm-dd',
                                autoclose: true,
                                todayHighlight: true,
                                orientation: "bottom auto"
                            });
                            dateInput.addEventListener("change", () => {
                                const tasks = getTasks();
                                const newDate = dateInput.value;
                                // Move to archive if date is not today
                                if (newDate !== currentDate) {
                                    // Remove from today
                                    const movedTask = tasks[currentUser].today.splice(idx, 1)[0];
                                    movedTask.date = newDate;
                                    if (!tasks[currentUser].archive[newDate]) tasks[currentUser].archive[newDate] = [];
                                    tasks[currentUser].archive[newDate].push(movedTask);
                                } else {
                                    tasks[currentUser].today[idx].date = newDate;
                                }
                                saveTasks(tasks);
                                loadTodayTasks();
                            });
                            div.appendChild(dateInput);

                            // Edit/Delete icons
                            const icons = document.createElement("span");
                            icons.className = "task-edit-icons";

                            // Edit icon (focus input)
                            const editBtn = document.createElement("button");
                            editBtn.className = "btn btn-sm btn-outline-primary";
                            editBtn.textContent = "Edit";
                            editBtn.addEventListener("click", () => {
                                input.focus();
                            });
                            icons.appendChild(editBtn);

                            // Delete icon (delete this task)
                            const delBtn = document.createElement("button");
                            delBtn.className = "btn btn-sm btn-outline-danger";
                            delBtn.textContent = "Delete";
                            delBtn.addEventListener("click", () => {
                                const tasks = getTasks();
                                tasks[currentUser].today.splice(idx, 1);
                                saveTasks(tasks);
                                loadTodayTasks();
                            });
                            icons.appendChild(delBtn);

                            div.appendChild(icons);
                        } else {
                            // Not in edit mode: just show text and date
                            div.textContent = `${taskObj.text} (${taskObj.date})`;
                        }

                        container.appendChild(div);
                    });
                }

                // --- Today Edit Button Logic ---
                const todayEditBtn = document.getElementById("today-edit-btn");
                const todayDeleteSelectedBtn = document.getElementById("today-delete-selected-btn");

                todayEditBtn.addEventListener("click", async () => {
                    if (!todayEditMode) {
                        todayEditMode = true;
                        todayEditBtn.querySelector("#today-edit-btn-label").textContent = "DONE";
                        todayDeleteSelectedBtn.style.display = "";
                        todaySelectedTasks.clear();
                        loadTodayTasks();
                    } else {
                        // If any selected, confirm deletion
                        if (todaySelectedTasks.size > 0) {
                            const confirmed = await showConfirmModal("Are you sure you want to delete the selected tasks?");
                            if (confirmed) {
                                const tasks = getTasks();
                                // Remove by index, highest to lowest to avoid reindexing issues
                                const idxs = Array.from(todaySelectedTasks).sort((a, b) => b - a);
                                idxs.forEach(idx => {
                                    tasks[currentUser].today.splice(idx, 1);
                                });
                                saveTasks(tasks);
                            }
                            todaySelectedTasks.clear();
                        }
                        todayEditMode = false;
                        todayEditBtn.querySelector("#today-edit-btn-label").textContent = "EDIT";
                        todayDeleteSelectedBtn.style.display = "none";
                        loadTodayTasks();
                    }
                });

                todayDeleteSelectedBtn.addEventListener("click", async () => {
                    if (todaySelectedTasks.size === 0) {
                        alert("No tasks selected.");
                        return;
                    }
                    const confirmed = await showConfirmModal("Are you sure you want to delete the selected tasks?");
                    if (!confirmed) return;

                    const tasks = getTasks();
                    // Remove by index, highest to lowest to avoid reindexing issues
                    const idxs = Array.from(todaySelectedTasks).sort((a, b) => b - a);
                    idxs.forEach(idx => {
                        tasks[currentUser].today.splice(idx, 1);
                    });
                    saveTasks(tasks);
                    todaySelectedTasks.clear();
                    loadTodayTasks();
                });

                // --- Archive Tab Edit Mode ---
                const archiveEditBtn = document.getElementById("archive-edit-btn");
                const archiveDeleteSelectedBtn = document.getElementById("archive-delete-selected-btn");
                let archiveEditMode = false;
                let archiveSelectedTasks = new Set();

                archiveEditBtn.addEventListener("click", async () => {
                    if (!archiveEditMode) {
                        archiveEditMode = true;
                        archiveEditBtn.querySelector("#archive-edit-btn-label").textContent = "DONE";
                        archiveDeleteSelectedBtn.style.display = "";
                        archiveSelectedTasks.clear();
                        loadArchiveDate(document.getElementById('archive-date-display').textContent);
                    } else {
                        // Confirm deletion if any selected
                        if (archiveSelectedTasks.size > 0) {
                            const confirmed = await showConfirmModal("Are you sure you want to delete the selected tasks?");
                            if (confirmed) {
                                const tasks = getTasks();
                                const dateStr = document.getElementById('archive-date-display').textContent;
                                const todayObj = new Date();
                                const todayStr = todayObj.getFullYear() + "-" +
                                    String(todayObj.getMonth() + 1).padStart(2, "0") + "-" +
                                    String(todayObj.getDate()).padStart(2, "0");
                                let arr;
                                if (dateStr === todayStr) {
                                    arr = tasks[currentUser].today;
                                } else {
                                    arr = tasks[currentUser].archive[dateStr] || [];
                                }
                                // Remove by index, highest to lowest
                                const idxs = Array.from(archiveSelectedTasks).sort((a, b) => b - a);
                                idxs.forEach(idx => arr.splice(idx, 1));
                                saveTasks(tasks);
                            }
                            archiveSelectedTasks.clear();
                        }
                        archiveEditMode = false;
                        archiveEditBtn.querySelector("#archive-edit-btn-label").textContent = "EDIT";
                        archiveDeleteSelectedBtn.style.display = "none";
                        loadArchiveDate(new Date(document.getElementById('archive-date-display').textContent));
                    }
                });

                archiveDeleteSelectedBtn.addEventListener("click", async () => {
                    if (archiveSelectedTasks.size === 0) {
                        alert("No tasks selected.");
                        return;
                    }
                    const confirmed = await showConfirmModal("Are you sure you want to delete the selected tasks?");
                    if (!confirmed) return;
                    const tasks = getTasks();
                    const dateStr = document.getElementById('archive-date-display').textContent;
                    const todayObj = new Date();
                    const todayStr = todayObj.getFullYear() + "-" +
                        String(todayObj.getMonth() + 1).padStart(2, "0") + "-" +
                        String(todayObj.getDate()).padStart(2, "0");
                    let arr;
                    if (dateStr === todayStr) {
                        arr = tasks[currentUser].today;
                    } else {
                        arr = tasks[currentUser].archive[dateStr] || [];
                    }
                    // Remove by index, highest to lowest
                    const idxs = Array.from(archiveSelectedTasks).sort((a, b) => b - a);
                    idxs.forEach(idx => arr.splice(idx, 1));
                    saveTasks(tasks);
                    archiveSelectedTasks.clear();
                    loadArchiveDate(new Date(dateStr));
                });

                function renderArchiveTaskList(tasksArray, container, archiveDate, todayStr) {
                    container.innerHTML = "";
                    if (tasksArray.length === 0) {
                        container.innerHTML = "<p><em>No tasks</em></p>";
                        return;
                    }
                    tasksArray.forEach((taskObj, idx) => {
                        const div = document.createElement("div");
                        div.className = "task-item";
                        if (archiveEditMode) div.classList.add("edit-mode");

                        if (archiveEditMode) {
                            // Checkbox for selection
                            const checkbox = document.createElement("input");
                            checkbox.type = "checkbox";
                            checkbox.className = "task-checkbox";
                            checkbox.checked = archiveSelectedTasks.has(idx);
                            checkbox.addEventListener("change", () => {
                                if (checkbox.checked) archiveSelectedTasks.add(idx);
                                else archiveSelectedTasks.delete(idx);
                            });
                            div.appendChild(checkbox);

                            // Editable input for text
                            const input = document.createElement("input");
                            input.type = "text";
                            input.value = taskObj.text;
                            input.style.marginRight = "0.5em";
                            input.addEventListener("change", () => {
                                const tasks = getTasks();
                                if (archiveDate === todayStr) {
                                    const tIdx = tasks[currentUser].today.findIndex(t => t.text === taskObj.text && t.date === taskObj.date);
                                    if (tIdx > -1) tasks[currentUser].today[tIdx].text = input.value.trim();
                                } else {
                                    tasks[currentUser].archive[archiveDate][idx].text = input.value.trim();
                                }
                                saveTasks(tasks);
                            });
                            div.appendChild(input);

                            // Editable input for date
                            const dateInput = document.createElement("input");
                            dateInput.type = "text";
                            dateInput.value = taskObj.date;
                            dateInput.style.width = "120px";
                            $(dateInput).datepicker({
                                format: 'yyyy-mm-dd',
                                autoclose: true,
                                todayHighlight: true,
                                orientation: "bottom auto"
                            });
                            dateInput.addEventListener("change", () => {
                                const tasks = getTasks();
                                const newDate = dateInput.value;
                                if (archiveDate === todayStr) {
                                    const tIdx = tasks[currentUser].today.findIndex(t => t.text === taskObj.text && t.date === taskObj.date);
                                    if (newDate !== todayStr && tIdx > -1) {
                                        const movedTask = tasks[currentUser].today.splice(tIdx, 1)[0];
                                        movedTask.date = newDate;
                                        if (!tasks[currentUser].archive[newDate]) tasks[currentUser].archive[newDate] = [];
                                        tasks[currentUser].archive[newDate].push(movedTask);
                                    } else if (tIdx > -1) {
                                        tasks[currentUser].today[tIdx].date = newDate;
                                    }
                                } else {
                                    if (newDate === todayStr) {
                                        const movedTask = tasks[currentUser].archive[archiveDate].splice(idx, 1)[0];
                                        movedTask.date = newDate;
                                        tasks[currentUser].today.push(movedTask);
                                    } else {
                                        const movedTask = tasks[currentUser].archive[archiveDate].splice(idx, 1)[0];
                                        movedTask.date = newDate;
                                        if (!tasks[currentUser].archive[newDate]) tasks[currentUser].archive[newDate] = [];
                                        tasks[currentUser].archive[newDate].push(movedTask);
                                    }
                                }
                                saveTasks(tasks);
                                loadArchiveDate(new Date(newDate));
                            });
                            div.appendChild(dateInput);

                            // Edit/Delete icons
                            const icons = document.createElement("span");
                            icons.className = "task-edit-icons";

                            // Edit icon (focus input)
                            const editBtn = document.createElement("button");
                            editBtn.className = "btn btn-sm btn-outline-primary";
                            editBtn.textContent = "Edit";
                            editBtn.addEventListener("click", () => {
                                input.focus();
                            });
                            icons.appendChild(editBtn);

                            // Delete icon (delete this task)
                            const delBtn = document.createElement("button");
                            delBtn.className = "btn btn-sm btn-outline-danger";
                            delBtn.textContent = "Delete";
                            delBtn.addEventListener("click", async () => {
                                const confirmed = await showConfirmModal("Are you sure you want to delete this task?");
                                if (!confirmed) return;
                                const tasks = getTasks();
                                if (archiveDate === todayStr) {
                                    const tIdx = tasks[currentUser].today.findIndex(t => t.text === taskObj.text && t.date === taskObj.date);
                                    if (tIdx > -1) tasks[currentUser].today.splice(tIdx, 1);
                                } else {
                                    tasks[currentUser].archive[archiveDate].splice(idx, 1);
                                }
                                saveTasks(tasks);
                                loadArchiveDate(new Date(archiveDate));
                            });
                            icons.appendChild(delBtn);

                            div.appendChild(icons);
                        } else {
                            // Read-only
                            div.textContent = `${taskObj.text} (${taskObj.date})`;
                        }

                        container.appendChild(div);
                    });
                }

                // --- Archive and View Tasks Fixes ---
                function loadArchiveDate(dateInput) {
                    let dateObj;
                    if (dateInput instanceof Date && !isNaN(dateInput)) {
                        dateObj = dateInput;
                    } else if (typeof dateInput === "string" && /^\d{4}-\d{2}-\d{2}$/.test(dateInput)) {
                        // Parse yyyy-mm-dd string
                        const [yyyy, mm, dd] = dateInput.split('-');
                        dateObj = new Date(Number(yyyy), Number(mm) - 1, Number(dd));
                    } else {
                        dateObj = new Date();
                    }
                    const yyyy = dateObj.getFullYear();
                    const mm = (dateObj.getMonth() + 1).toString().padStart(2, "0");
                    const dd = dateObj.getDate().toString().padStart(2, "0");
                    const dateStr = `${yyyy}-${mm}-${dd}`;

                    const tasks = getTasks();
                    const userData = tasks[currentUser] || {};
                    const archivedTasks = userData.archive || {};
                    const todayTasks = userData.today || [];

                    let tasksForDate = (archivedTasks[dateStr] || []).filter(t => t && typeof t === "object");

                    const todayObj = new Date();
                    const todayStr = `${todayObj.getFullYear()}-${(todayObj.getMonth() + 1).toString().padStart(2, "0")}-${todayObj.getDate().toString().padStart(2, "0")}`;
                    if (dateStr === todayStr) {
                        tasksForDate = tasksForDate.concat(
                            todayTasks.filter(t => t && typeof t === "object" && t.date === todayStr)
                        );
                    }

                    renderArchiveTaskList(tasksForDate, archiveTasksList, dateStr, todayStr);
                }

                function loadUsersTasksForDate(dateStr) {
                    const users = getUsers();
                    const tasks = getTasks();
                    const accordion = document.getElementById("users-tasks-accordion");
                    accordion.innerHTML = "";

                    Object.keys(users).forEach((username, index) => {
                        const item = document.createElement("div");
                        item.className = "accordion-item";

                        const headerId = `heading-${index}`;
                        const collapseId = `collapse-${index}`;

                        const header = document.createElement("h2");
                        header.className = "accordion-header";
                        header.id = headerId;

                        const button = document.createElement("button");
                        button.className = "accordion-button collapsed";
                        button.type = "button";
                        button.setAttribute("data-bs-toggle", "collapse");
                        button.setAttribute("data-bs-target", `#${collapseId}`);
                        button.setAttribute("aria-expanded", "false");
                        button.setAttribute("aria-controls", collapseId);
                        button.textContent = username;

                        header.appendChild(button);

                        const collapse = document.createElement("div");
                        collapse.id = collapseId;
                        collapse.className = "accordion-collapse collapse";
                        collapse.setAttribute("aria-labelledby", headerId);
                        collapse.setAttribute("data-bs-parent", "#users-tasks-accordion");

                        const body = document.createElement("div");
                        body.className = "accordion-body";

                        // Collect tasks for the user on the selected date
                        let userTasksForDate = [];
                        if (tasks[username]) {
                            if (tasks[username].archive && tasks[username].archive[dateStr]) {
                                userTasksForDate = userTasksForDate.concat(tasks[username].archive[dateStr]);
                            }
                            // Include today's tasks if the selected date is today
                            const todayObj = new Date();
                            const todayStr = todayObj.getFullYear() + "-" +
                                String(todayObj.getMonth() + 1).padStart(2, "0") + "-" +
                                String(todayObj.getDate()).padStart(2, "0");
                            if (dateStr === todayStr && tasks[username].today) {
                                userTasksForDate = userTasksForDate.concat(tasks[username].today.filter(t => t.date === todayStr));
                            }
                        }

                        // Inject holiday
                        const holidays = getHolidayForDate(dateStr);
                        holidays.forEach(h => {
                            userTasksForDate.unshift({ text: `Holiday - ${h.name}`, date: dateStr });
                        });

                        if (userTasksForDate.length === 0) {
                            body.innerHTML = "<p><em>No tasks for this date.</em></p>";
                        } else {
                            const ul = document.createElement("ul");
                            ul.className = "list-group";
                            userTasksForDate.forEach(task => {
                                const li = document.createElement("li");
                                li.className = "list-group-item";
                                li.textContent = `${task.text} (${task.date})`;
                                ul.appendChild(li);
                            });
                            body.appendChild(ul);
                        }

                        collapse.appendChild(body);
                        item.appendChild(header);
                        item.appendChild(collapse);
                        accordion.appendChild(item);
                    });
                }

                // --- On page load, check session ---
                function init() {
                    const savedUser = sessionStorage.getItem(SESSION_USER_KEY);
                    if (savedUser && getUsers()[savedUser]) {
                        currentUser = savedUser;
                        ensureAllUsersTaskStructure(); // <-- Use this
                        authDiv.style.display = "none";
                        appDiv.style.display = "block";
                        currentUserNameSpan.textContent = currentUser;
                        setupAdminTab();
                        loadTodayTasks();
                        loadArchiveDate(new Date());
                    } else {
                        authDiv.style.display = "block";
                        appDiv.style.display = "none";
                    }

                    //Initialize task list
                    document.getElementById('today-tab').addEventListener('shown.bs.tab', function () {
                        loadTodayTasks();
                    });
                    document.getElementById('archive-tab').addEventListener('shown.bs.tab', function () {
                        loadArchiveDate(document.getElementById('archive-date-display').textContent);
                    });
                    document.getElementById('view-users-tab').addEventListener('shown.bs.tab', function () {
                        const date = document.getElementById('view-tasks-date').value;
                        loadUsersTasksForDate(date);
                    });
                }

                init();

                document.getElementById('archive-tab').addEventListener('shown.bs.tab', function () {
                    loadArchiveDate(document.getElementById('archive-date-display').textContent);
                });
            })();

            function showConfirmModal(message) {
                return new Promise((resolve) => {
                    const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
                    document.getElementById('confirmModalBody').textContent = message;

                    const okBtn = document.getElementById('confirmModalOk');
                    const cancelBtn = document.getElementById('confirmModalCancel');

                    function cleanup(result) {
                        okBtn.removeEventListener('click', onOk);
                        cancelBtn.removeEventListener('click', onCancel);
                        document.getElementById('confirmModal').removeEventListener('hidden.bs.modal', onCancel);
                        resolve(result);
                    }
                    function onOk() {
                        modal.hide();
                        cleanup(true);
                    }
                    function onCancel() {
                        cleanup(false);
                    }

                    okBtn.addEventListener('click', onOk);
                    cancelBtn.addEventListener('click', onCancel);
                    document.getElementById('confirmModal').addEventListener('hidden.bs.modal', onCancel);

                    modal.show();
                });
            }

        </script>

</body>

</html>